datasource db {
  provider = "postgresql"
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}
// -----------------------------------------------------------------------------
// ENUMS
// -----------------------------------------------------------------------------
enum UserRole {
  USER
  ADMIN
  VERIFIER
  AUDITOR
}
enum Gender {
  MALE
  FEMALE
  OTHERS
}
enum DocumentStatus {
  PENDING_UPLOAD
  PENDING_VERIFICATION
  VERIFIED
  REJECTED
  EXPIRED
}
enum ReferenceType {
  TITLE_DEED
  NATIONAL_ID
  DEATH_CERTIFICATE
  BIRTH_CERTIFICATE
  MARRIAGE_CERTIFICATE
  KRA_PIN
  OTHER
}
enum AssetCategory {
  LAND              // Title deeds, plots
  PROPERTY          // Houses, apartments, commercial buildings
  VEHICLE           // Cars, motorcycles, tractors
  BANK_ACCOUNT      // Savings, current accounts
  INVESTMENT        // Shares, bonds, SACCOs, M-Akiba
  BUSINESS          // Business ownership, partnerships
  LIVESTOCK         // Cattle, goats, poultry (very Kenyan!)
  PERSONAL_EFFECTS  // Jewelry, furniture, electronics
  OTHER
}
enum AssetStatus {
  ACTIVE           // Normal state
  VERIFIED         // User has uploaded proof
  ENCUMBERED       // Has mortgage/charge
  DISPUTED         // Someone is contesting ownership
  LIQUIDATED       // Sold/converted to cash
}
enum LandCategory {
  RESIDENTIAL      // Home, apartment
  AGRICULTURAL     // Farm, shamba
  COMMERCIAL       // Shop, office building
  INDUSTRIAL       // Factory, warehouse
  VACANT           // Undeveloped plot
}
enum VehicleCategory {
  PERSONAL_CAR
  COMMERCIAL_VEHICLE  // Matatu, lorry
  MOTORCYCLE
  TRACTOR
}
enum DebtCategory {
  MORTGAGE
  BANK_LOAN
  SACCO_LOAN
  PERSONAL_LOAN
  MOBILE_LOAN        // Fuliza, M-Shwari, Tala (very Kenyan!)
  FUNERAL_EXPENSES
  MEDICAL_BILLS
  TAXES_OWED
  OTHER
}
enum DebtPriority {
  CRITICAL          // Funeral, taxes (S.45 LSA)
  HIGH              // Secured debts (mortgages)
  MEDIUM            // Priority unsecured
  LOW               // General unsecured
}
enum DebtStatus {
  OUTSTANDING
  PARTIALLY_PAID
  PAID_IN_FULL
  DISPUTED
  WRITTEN_OFF
}
enum WillStatus {
  DRAFT             // Being created
  ACTIVE            // Current valid will
  SUPERSEDED        // Replaced by newer will
  REVOKED           // Cancelled
  EXECUTED          // Person has died
}
enum BeneficiaryType {
  SPOUSE
  CHILD
  PARENT
  SIBLING
  FRIEND
  CHARITY
  OTHER
}
enum BequestType {
  SPECIFIC_ASSET    // "My land in Kiambu goes to John"
  PERCENTAGE        // "30% of everything goes to Mary"
  CASH_AMOUNT       // "KES 500,000 to my church"
  RESIDUAL          // "Everything else goes to..."
}
enum WitnessStatus {
  PENDING           // Not yet signed
  SIGNED            // Has witnessed
  DECLINED          // Refused to witness
}
enum SuccessionRegime {
  TESTATE              // Has valid will
  INTESTATE            // No will
  PARTIALLY_INTESTATE  // Will doesn't cover all assets
}

enum SuccessionReligion {
  STATUTORY            // General Kenyan law
  ISLAMIC              // Kadhi's court
  HINDU                // Hindu Succession Act
  CUSTOMARY            // African customary law
}

enum MarriageType {
  MONOGAMOUS
  POLYGAMOUS
  COHABITATION
  SINGLE
}

enum CourtJurisdiction {
  HIGH_COURT           // Estate > 1M or complex
  MAGISTRATE_COURT     // Estate < 1M
  KADHIS_COURT         // Islamic succession
  CUSTOMARY_COURT      // Traditional law
}

// --- READINESS ENUMS ---
enum ReadinessStatus {
  NOT_STARTED          // 0-20%
  IN_PROGRESS          // 21-79%
  READY                // 80-99%
  COMPLETE             // 100%
}

enum RiskSeverity {
  INFO                 // Just FYI
  LOW                  // Minor issue
  MEDIUM               // Should fix
  HIGH                 // Important
  CRITICAL             // Blocking issue
}

enum RiskCategory {
  MISSING_DOCUMENT
  INVALID_DOCUMENT
  MINOR_WITHOUT_GUARDIAN
  MISSING_VALUATION
  JURISDICTION_ISSUE
  TAX_CLEARANCE
  FAMILY_DISPUTE
  WITNESS_ISSUE
  EXECUTOR_ISSUE
  OTHER
}

// --- ROADMAP ENUMS ---
enum RoadmapPhase {
  PRE_FILING           // Prepare documents
  FILING               // Submit to court
  COURT_PROCESS        // Attend hearings
  GRANT_ISSUANCE       // Receive grant
  DISTRIBUTION         // Distribute assets
}

enum TaskStatus {
  LOCKED               // Not yet available
  AVAILABLE            // Can start now
  IN_PROGRESS          // Currently working on
  COMPLETED            // Done
  SKIPPED              // User chose to skip
}

enum TaskCategory {
  IDENTITY_VERIFICATION
  ASSET_DISCOVERY
  DEBT_SETTLEMENT
  DOCUMENT_COLLECTION
  VALUATION
  LEGAL_REQUIREMENT
  COURT_FILING
  FAMILY_CONSENT
  GUARDIANSHIP
  TAX_COMPLIANCE
}

// --- PROBATE FORM ENUMS ---
enum KenyanFormType {
  PA1_PROBATE              // Petition for Probate (Testate)
  PA80_INTESTATE           // Petition for Letters of Admin (Intestate)
  PA5_SUMMARY              // Summary Administration (<500k)
  PA12_AFFIDAVIT_MEANS     // Affidavit of Means (Asset list)
  PA38_FAMILY_CONSENT      // Consent of family members
  CHIEFS_LETTER            // Letter from Area Chief
  ISLAMIC_PETITION         // For Kadhi's Court
}
enum RelationshipType {
  SELF              // The user themselves
  FATHER
  MOTHER
  SPOUSE
  CHILD
  ADOPTED_CHILD
  SIBLING
  HALF_SIBLING      // Same father or mother, different other parent
}
enum MarriageStatus {
  ACTIVE
  DIVORCED
  ANNULLED
  WIDOWED
}
enum GuardianshipStatus {
  DRAFT             // Form started
  PENDING_REVIEW    // Checklist submitted
  ELIGIBLE          // Passed all checks
  CONDITIONAL       // Passed with warnings
  INELIGIBLE        // Failed critical checks
  ACTIVE            // Approved and active
  SUSPENDED         // Temporarily paused
  TERMINATED        // Ended
}
enum VerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  DISPUTED
  REJECTED
}

enum KenyanCounty {
  BARINGO
  BOMET
  BUNGOMA
  BUSIA
  ELGEYO_MARAKWET
  EMBU
  GARISSA
  HOMA_BAY
  ISIOLO
  KAJIADO
  KAKAMEGA
  KERICHO
  KIAMBU
  KILIFI
  KIRINYAGA
  KISII
  KISUMU
  KITUI
  KWALE
  LAIKIPIA
  LAMU
  MACHAKOS
  MAKUENI
  MANDERA
  MARSABIT
  MERU
  MIGORI
  MOMBASA
  MURANGA
  NAIROBI
  NAKURU
  NANDI
  NAROK
  NYAMIRA
  NYANDARUA
  NYERI
  SAMBURU
  SIAYA
  TAITA_TAVETA
  TANA_RIVER
  THARAKA_NITHI
  TRANS_NZOIA
  TURKANA
  UASIN_GISHU
  VIHIGA
  WAJIR
  WEST_POKOT
}
// ============================================================================
// ACCOUNTS SERVICE MODELS
// Owner: accounts-service
// ============================================================================

model User {
  id              String   @id @default(uuid()) @db.Uuid()
  email           String   @unique(map: "users_email_unique") @db.VarChar(255)
  password        String   @db.VarChar(255) // Argon2id hashed password
  firstName       String   @db.VarChar(100)
  lastName        String   @db.VarChar(100)
  role            UserRole @default(USER)
  isActive        Boolean  @default(true)
  lastLoginAt     DateTime?
  loginAttempts   Int      @default(0)
  lockedUntil     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  // --- Relationships Owned by this Service ---
  profile                UserProfile?
  passwordResetTokens    PasswordResetToken[]
  refreshTokens          RefreshToken[]
  roleChanges            RoleChange[]
  emailVerificationToken EmailVerificationToken?
  phoneVerificationTokens PhoneVerificationToken[]
  emailChangeTokens      EmailChangeToken[]
  loginSessions          LoginSession[]
  passwordHistory        PasswordHistory[]

  // --- Back-relations from other services ---
  documentsUploaded         Document[]              @relation("DocumentUploader") 
  // Back-relations from Family-Service
  createdFamilies     Family[]       @relation("FamilyCreator")
  familyMemberships   FamilyMember[] @relation("FamilyMemberUser")
  // Back-relations from Estate-Service
  
  willsAuthored       Will[] @relation("TestatorWills")
  assetsOwned         Asset[]        @relation("AssetOwner")
  @@index([email, isActive], map: "users_email_isActive_idx")
  @@index([createdAt], map: "users_createdAt_idx")
  @@index([deletedAt], map: "users_deletedAt_idx")
  @@map("users")
}
model UserProfile {
  id            String   @id @default(uuid()) @db.Uuid()
  userId        String   @unique(map: "user_profiles_userId_unique") @db.Uuid()
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  bio            String?   @db.Text
  phoneNumber    String?   @db.VarChar(20)
  phoneVerified  Boolean   @default(false)
  emailVerified  Boolean   @default(false)
  marketingOptIn Boolean   @default(false)
  address        Json?     // {street, city, county, postalCode}
  nextOfKin      Json?     // {name, relationship, phone, email}

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([phoneNumber], map: "user_profiles_phoneNumber_idx")
  @@map("user_profiles")
}
model PasswordResetToken {
  id        String   @id @default(uuid()) @db.Uuid()
  tokenHash String   @unique(map: "password_reset_tokens_tokenHash_unique") @db.VarChar(255)
  expiresAt DateTime
  used      Boolean  @default(false)
  userId    String   @db.Uuid()
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  createdAt DateTime @default(now())

  @@index([userId, used], map: "password_reset_tokens_userId_used_idx")
  @@index([expiresAt], map: "password_reset_tokens_expiresAt_idx")
  @@map("password_reset_tokens")
}
model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid()
  tokenHash String   @unique(map: "refresh_tokens_tokenHash_unique") @db.VarChar(255)
  expiresAt DateTime
  userId    String   @db.Uuid()
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  deviceId  String?  @db.VarChar(255)
  ipAddress String?  @db.VarChar(45) // IPv6 support
  userAgent String?  @db.Text
  createdAt DateTime @default(now())
  revokedAt DateTime?
  lastUsedAt DateTime?

  @@index([userId], map: "refresh_tokens_userId_idx")
  @@index([expiresAt], map: "refresh_tokens_expiresAt_idx")
  @@map("refresh_tokens")
}
model RoleChange {
  id        String   @id @default(uuid()) @db.Uuid()
  userId    String   @db.Uuid()
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  oldRole   UserRole
  newRole   UserRole
  changedBy String?  @db.Uuid()
  reason    String?  @db.Text
  
  createdAt DateTime @default(now())

  @@index([userId], map: "role_changes_userId_idx")
  @@index([createdAt], map: "role_changes_createdAt_idx")
  @@map("role_changes")
}
model EmailVerificationToken {
  id        String   @id @default(uuid()) @db.Uuid()
  tokenHash String   @unique(map: "email_verification_tokens_tokenHash_unique") @db.VarChar(255)
  expiresAt DateTime
  userId    String   @unique(map: "email_verification_tokens_userId_unique") @db.Uuid()
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  createdAt DateTime @default(now())

  @@index([expiresAt], map: "email_verification_tokens_expiresAt_idx")
  @@map("email_verification_tokens")
}
model PhoneVerificationToken {
  id        String   @id @default(uuid()) @db.Uuid()
  tokenHash String   @unique(map: "phone_verification_tokens_tokenHash_unique") @db.VarChar(255)
  expiresAt DateTime
  userId    String   @db.Uuid()
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  used      Boolean  @default(false)
  attempts  Int      @default(0) // Track verification attempts
  createdAt DateTime @default(now())

  @@index([userId, used], map: "phone_verification_tokens_userId_used_idx")
  @@index([expiresAt], map: "phone_verification_tokens_expiresAt_idx")
  @@map("phone_verification_tokens")
}
model EmailChangeToken {
  id        String   @id @default(uuid()) @db.Uuid()
  userId    String   @db.Uuid()
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  newEmail     String   @db.VarChar(255)
  tokenHash    String   @unique(map: "email_change_tokens_tokenHash_unique") @db.VarChar(255)
  expiresAt    DateTime
  used         Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@index([userId, used], map: "email_change_tokens_userId_used_idx")
  @@index([expiresAt], map: "email_change_tokens_expiresAt_idx")
  @@map("email_change_tokens")
}
model LoginSession {
  id           String    @id @default(uuid()) @db.Uuid()
  userId       String    @db.Uuid()
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  tokenHash    String    @unique(map: "login_sessions_tokenHash_unique") @db.VarChar(255)
  ipAddress    String?   @db.VarChar(45) // IPv6 support
  userAgent    String?   @db.Text
  deviceId     String?   @db.VarChar(255)
  lastActivity DateTime  @default(now())
  expiresAt    DateTime
  revokedAt    DateTime? // For manual session termination
  createdAt    DateTime  @default(now())

  @@index([userId, expiresAt], map: "login_sessions_userId_expiresAt_idx")
  @@index([deviceId], map: "login_sessions_deviceId_idx")
  @@map("login_sessions")
}
model PasswordHistory {
  id           String   @id @default(uuid()) @db.Uuid()
  userId       String   @db.Uuid()
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  passwordHash String   @db.VarChar(255) // Store Argon2id hash of old password
  createdAt    DateTime @default(now())

  @@index([userId, createdAt], map: "password_history_userId_createdAt_idx")
  @@map("password_history")
}
// ============================================================================
// DOCUMENTS SERVICE MODELS
// Owner: documents-service
// ============================================================================
model Document {
  id                  String          @id @default(uuid()) @db.Uuid
  
  // User info
  uploaderId          String          @db.Uuid
  uploader            User            @relation("DocumentUploader", fields: [uploaderId], references: [id])
  documentName        String          @db.VarChar(200)
  // Extracted reference
  referenceNumber     String?         @db.VarChar(100)
  referenceType       ReferenceType?
  
  // Status
  status              DocumentStatus  @default(PENDING_UPLOAD)
  
  // Temporary storage (deleted after verification)
  storageKey          String?         @db.Text
  mimeType            String?         @db.VarChar(100)
  fileSizeBytes       Int?
  
  // Permanent encrypted reference
  encryptedReference  String?         @db.Text
  
  // Verification
  verifiedBy          String?         @db.Uuid
  verifiedAt          DateTime?
  rejectionReason     String?         @db.Text
  
  // OCR
  ocrConfidence       Float?
  ocrExtractedText    String?         @db.Text
  
  // Lifecycle
  uploadedAt          DateTime        @default(now())
  expiresAt           DateTime?
  deletedAt           DateTime?
  
  // Relations
  verificationAttempts VerificationAttempt[]
  assets Asset[]
  wills Will[]
  @@unique([referenceNumber, referenceType])
  @@index([uploaderId, status])
  @@index([status, expiresAt])
  @@map("documents")
}
model VerificationAttempt {
  id          String    @id @default(uuid()) @db.Uuid
  documentId  String    @db.Uuid
  document    Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  verifierId  String    @db.Uuid
  action      String    @db.VarChar(20) // "APPROVED" or "REJECTED"
  notes       String?   @db.Text
  
  createdAt   DateTime  @default(now())
  
  @@map("verification_attempts")
}
// ============================================================================
// FAMILY-SERVICE SCHEMA
// Purpose: Manages Identity, Kinship, and Legal Authority (Guardianship)
// Context: Kenyan Law (Marriage Act, Children Act, S.40 Succession Act)
// ============================================================================
// ============================================================================
// AGGREGATE ROOT 1: FAMILY
// Manages: Kinship, S.40 Structure, Identity
// ============================================================================
model Family {
  id          String   @id @default(uuid()) @db.Uuid
  
  // Owner (The user who created this family tree)
  creatorId   String   @db.Uuid
  creator     User     @relation("FamilyCreator", fields: [creatorId], references: [id])
  
  // Basic Info
  name        String   @db.VarChar(200) // "The Kamau Family"
  description String?  @db.Text
  
  // Cultural Context (Optional but nice for users)
  homeCounty  KenyanCounty?
  tribe       String?  @db.VarChar(50)
  clanName    String?  @db.VarChar(100)
  
  // Structure Detection (Auto-computed)
  isPolygamous Boolean @default(false)
  totalMembers Int     @default(0) // Denormalized for performance
  totalMinors  Int     @default(0)
  totalSpouses Int     @default(0)
  
  // Smart Features
  hasMissingLinks Boolean @default(false) // "You added children but no mother"
  completenessScore Int   @default(0)     // 0-100, based on required fields filled
  
  // Members
  members     FamilyMember[]
  marriages   Marriage[]
  houses      PolygamousHouse[]
  guardianships Guardianship[]
  
  // Analytics (for dashboard)
  lastActivityAt DateTime @default(now())
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime? // Soft delete
  
  @@index([creatorId])
  @@map("families")
}

// ============================================================================
// ENTITY: FAMILY MEMBER
// ============================================================================
model FamilyMember {
  id             String   @id @default(uuid()) @db.Uuid
  
  // Family Link
  familyId       String   @db.Uuid
  family         Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  // Optional User Link (if they register on the platform)
  userId         String?  @unique @db.Uuid
  user           User?    @relation("FamilyMemberUser", fields: [userId], references: [id])
  
  // === CORE IDENTITY ===
  firstName      String   @db.VarChar(100)
  middleName     String?  @db.VarChar(100)
  lastName       String   @db.VarChar(100)
  maidenName     String?  @db.VarChar(100) // For married women
  
  // Relationship to Family Creator
  relationship   RelationshipType
  
  // === DEMOGRAPHICS ===
  gender         Gender?
  dateOfBirth    DateTime?
  placeOfBirth   String?  @db.VarChar(200)
  
  // Kenyan Identity Documents
  nationalId     String?  @unique @db.VarChar(20)
  birthCertNo    String?  @db.VarChar(50)
  kraPin         String?  @db.VarChar(20)
  passportNumber String?  @db.VarChar(50)
  
  // === LIFE STATUS ===
  isAlive        Boolean  @default(true)
  dateOfDeath    DateTime?
  deathCertNo    String?  @db.VarChar(50)
  causeOfDeath   String?  @db.Text
  placeOfDeath   String?  @db.VarChar(200)
  
  // === SPECIAL STATUSES ===
  isMinor        Boolean  @default(false) // Auto-computed: age < 18
  age            Int?                     // Auto-computed from dateOfBirth
  
  // Disability (for dependency assessment)
  hasDisability  Boolean  @default(false)
  disabilityType String?  @db.Text
  
  // Mental Capacity (for guardianship)
  isMentallyCapable Boolean @default(true)
  
  // === ADOPTION ===
  isAdopted      Boolean  @default(false)
  adoptionType   String?  // "LEGAL", "CUSTOMARY"
  adoptionDate   DateTime?
  biologicalParentIds String[] // Array of UUIDs (weak reference)
  
  // === POLYGAMY (Section 40 Logic) ===
  polygamousHouseId String? @db.Uuid
  polygamousHouse   PolygamousHouse? @relation(fields: [polygamousHouseId], references: [id])
  
  // === CONTACT INFO ===
  phoneNumber    String?  @db.VarChar(20)
  email          String?  @db.VarChar(255)
  currentAddress String?  @db.Text
  
  // === VERIFICATION ===
  verificationStatus VerificationStatus @default(UNVERIFIED)
  verifiedAt         DateTime?
  verifiedBy         String?  @db.Uuid // Admin/Verifier ID
  
  // === RELATIONS ===
  // Marriages
  marriagesAsSpouse1 Marriage[] @relation("Spouse1")
  marriagesAsSpouse2 Marriage[] @relation("Spouse2")
  
  // Guardianship
  guardiansAssignedToMe GuardianAssignment[] @relation("Ward")
  guardiansIProvide     GuardianAssignment[] @relation("Guardian")
  
  assets Asset[] @relation("FamilyMemberLifeInterest")
  // === AUDIT ===
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  deletedAt      DateTime? // Soft delete
  
  @@index([familyId, relationship])
  @@index([nationalId])
  @@index([isAlive])
  @@map("family_members")
}

// ============================================================================
// ENTITY: MARRIAGE
// ============================================================================
model Marriage {
  id            String   @id @default(uuid()) @db.Uuid
  
  familyId      String   @db.Uuid
  family        Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  // === SPOUSES ===
  spouse1Id     String   @db.Uuid
  spouse1       FamilyMember @relation("Spouse1", fields: [spouse1Id], references: [id])
  
  spouse2Id     String   @db.Uuid
  spouse2       FamilyMember @relation("Spouse2", fields: [spouse2Id], references: [id])
  
  // === TYPE & STATUS ===
  type          MarriageType
  status        MarriageStatus @default(ACTIVE)
  
  // === DATES ===
  marriageDate  DateTime
  divorceDate   DateTime?
  
  // === POLYGAMY ===
  isPolygamous  Boolean  @default(false)
  marriageOrder Int?     // 1st wife, 2nd wife (only for polygamous)
  
  polygamousHouseId String? @db.Uuid
  polygamousHouse   PolygamousHouse? @relation(fields: [polygamousHouseId], references: [id])
  
  // === REGISTRATION ===
  certNumber    String?  @unique @db.VarChar(100)
  registeredAt  DateTime?
  registryOffice String? @db.VarChar(200)
  
  // === CHILDREN (Denormalized count) ===
  numberOfChildren Int @default(0)
  
  // === VERIFICATION ===
  verificationStatus VerificationStatus @default(UNVERIFIED)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([familyId])
  @@map("marriages")
}

// ============================================================================
// ENTITY: POLYGAMOUS HOUSE (Section 40 - Succession Act)
// ============================================================================
model PolygamousHouse {
  id            String   @id @default(uuid()) @db.Uuid
  
  familyId      String   @db.Uuid
  family        Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  // === IDENTITY ===
  houseName     String   @db.VarChar(100) // "House of Wanjiku"
  houseOrder    Int      // 1st house, 2nd house, etc.
  houseCode     String   @db.VarChar(20)  // "H1", "H2", etc.
  
  // === MOTHER (The Wife) ===
  motherId      String   @db.Uuid // References FamilyMember
  motherName    String   @db.VarChar(200) // Denormalized for display
  
  // === CHILDREN ===
  // Automatically assigned based on biological mother
  children      FamilyMember[]
  childCount    Int      @default(0) // Denormalized
  
  // === MARRIAGES ===
  marriages     Marriage[]
  
  // === STATUS ===
  isActive      Boolean  @default(true)
  dissolutionDate DateTime?
  dissolutionReason String? @db.Text
  
  // === LEGAL CONTEXT ===
  // For succession: "House of Wanjiku gets X% of estate"
  legalNotes    String?  @db.Text
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([familyId, houseOrder])
  @@map("polygamous_houses")
}

// ============================================================================
// AGGREGATE ROOT: GUARDIANSHIP
// ============================================================================
model Guardianship {
  id          String   @id @default(uuid()) @db.Uuid
  
  // === FAMILY LINK ===
  familyId    String   @db.Uuid
  family      Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  // === THE MINOR (Ward) ===
  wardId      String   @db.Uuid // References FamilyMember
  wardName    String   @db.VarChar(200) // Denormalized
  wardAge     Int                       // Denormalized
  
  // === STATUS ===
  status      GuardianshipStatus @default(DRAFT)
  
  // === ELIGIBILITY CHECKLIST ===
  // Structure: { isOver18: bool, hasNoCriminalRecord: bool, ... }
  eligibilityChecklist Json?
  
  // === SCORING ===
  eligibilityScore     Int @default(0)  // 0-100
  proximityScore       Int @default(0)  // How close is guardian to ward?
  relationshipScore    Int @default(0)  // How close is relationship?
  overallScore         Int @default(0)  // Weighted average
  
  // === LEGAL COMPLIANCE (Children Act) ===
  legalReference String? @db.Text // "Section 70, Children Act (Cap 141)"
  warnings       String[]         // Array of warning messages
  blockingIssues String[]         // Critical issues preventing approval
  
  // === COURT INFO (Future) ===
  courtOrderNumber String? @db.VarChar(100)
  courtOrderDate   DateTime?
  courtStation     String?  @db.VarChar(200)
  
  // === ASSIGNMENTS ===
  // Can have multiple: primary guardian, alternate guardian
  assignments GuardianAssignment[]
  
  // === COMPLIANCE REPORTS (Future) ===
  // Annual reports required by law
  lastReportDate DateTime?
  nextReportDue  DateTime?
  isCompliant    Boolean @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([familyId])
  @@index([wardId])
  @@map("guardianships")
}

// ============================================================================
// ENTITY: GUARDIAN ASSIGNMENT
// ============================================================================
model GuardianAssignment {
  id              String   @id @default(uuid()) @db.Uuid
  
  // === GUARDIANSHIP ===
  guardianshipId  String   @db.Uuid
  guardianship    Guardianship @relation(fields: [guardianshipId], references: [id], onDelete: Cascade)
  
  // === GUARDIAN (The Adult) ===
  guardianId      String   @db.Uuid
  guardian        FamilyMember @relation("Guardian", fields: [guardianId], references: [id])
  guardianName    String   @db.VarChar(200) // Denormalized
  
  // === WARD (The Minor) ===
  wardId          String   @db.Uuid
  ward            FamilyMember @relation("Ward", fields: [wardId], references: [id])
  
  // === PRIORITY ===
  isPrimary       Boolean  @default(false)
  isAlternate     Boolean  @default(false)
  priorityOrder   Int      @default(1) // 1st choice, 2nd choice, etc.
  
  // === STATUS ===
  isActive        Boolean  @default(true)
  
  // === ELIGIBILITY (Snapshot) ===
  // Stored at time of assignment
  eligibilitySnapshot Json?
  eligibilityScore    Int @default(0)
  
  // === DATES ===
  appointedDate   DateTime @default(now())
  activatedDate   DateTime?
  suspendedDate   DateTime?
  terminatedDate  DateTime?
  
  // === TERMINATION ===
  terminationReason String? @db.Text
  
  // === LEGAL ===
  courtApproved   Boolean @default(false)
  courtOrderRef   String? @db.VarChar(100)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([guardianshipId, guardianId]) // One assignment per guardian per guardianship
  @@index([guardianId])
  @@index([wardId])
  @@map("guardian_assignments")
}
// ============================================================================
// ESTATE-SERVICE MODELS
// Purpose: Manages the Inventory (Estate) and Instructions (Will).
// Strict Boundaries: No Court Processes, No Grants, No Transmissions.
// ============================================================================
// =============================================================================
// 1. ESTATE (THE ECONOMIC TRUTH ENGINE)
// =============================================================================
model Estate {
  id          String   @id @default(uuid()) @db.Uuid
  
  // --- Owner ---
  userId      String   @unique @db.Uuid
  userName    String   // Denormalized for display
  kraPin      String?  @db.VarChar(20)
  
  // --- Net Worth Calculation (Auto-computed) ---
  totalAssets Decimal  @default(0) @db.Decimal(15, 2)
  totalDebts  Decimal  @default(0) @db.Decimal(15, 2)
  netWorth    Decimal  @default(0) @db.Decimal(15, 2)
  
  // --- Status Flags ---
  isInsolvent Boolean  @default(false) // Debts > Assets
  
  // --- Relations ---
  assets      Asset[]
  debts       Debt[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  readinessAssessments ReadinessAssessment[]
  @@map("estates")
}
// =============================================================================
// 2. ASSET (WHAT YOU OWN)
// =============================================================================
model Asset {
  id          String   @id @default(uuid()) @db.Uuid
  
  // --- Owner ---
  estateId    String   @db.Uuid
  estate      Estate   @relation(fields: [estateId], references: [id], onDelete: Cascade)
  
  // --- Basic Info ---
  name        String   @db.VarChar(200)
  description String?  @db.Text
  category    AssetCategory
  status      AssetStatus @default(ACTIVE)
  
  // --- Value ---
  estimatedValue Decimal  @db.Decimal(15, 2)
  currency       String   @default("KES")
  
  // --- Verification ---
  isVerified     Boolean  @default(false)
  proofDocumentUrl String? // Link to uploaded doc (title deed, logbook, etc)
  
  // --- Encumbrance ---
  isEncumbered   Boolean  @default(false)
  encumbranceDetails String? @db.Text // "Mortgage of KES 2M with Equity Bank"
  
  // --- Category-Specific Details ---
  landDetails    LandDetails?
  vehicleDetails VehicleDetails?
  
  // --- Metadata ---
  purchaseDate   DateTime?
  location       String?  @db.VarChar(200)
  
  // --- Relations ---
  bequests       Bequest[] // Who gets this in the will
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  users User[] @relation("AssetOwner")
  documents Document[]
  familyMembers FamilyMember[] @relation("FamilyMemberLifeInterest")
  @@index([estateId, category])
  @@map("assets")
}

// --- LAND SPECIFIC DETAILS ---
model LandDetails {
  id              String   @id @default(uuid()) @db.Uuid
  assetId         String   @unique @db.Uuid
  asset           Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  titleDeedNumber String   @db.VarChar(100)
  parcelNumber    String?  @db.VarChar(100)
  county          KenyanCounty
  subCounty       String?  @db.VarChar(100)
  landCategory    LandCategory
  sizeInAcres     Decimal? @db.Decimal(10, 2)
  
  @@map("land_details")
}

// --- VEHICLE SPECIFIC DETAILS ---
model VehicleDetails {
  id                 String   @id @default(uuid()) @db.Uuid
  assetId            String   @unique @db.Uuid
  asset              Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  registrationNumber String   @db.VarChar(20)
  make               String   @db.VarChar(100)
  model              String   @db.VarChar(100)
  year               Int?
  vehicleCategory    VehicleCategory
  
  @@map("vehicle_details")
}
// =============================================================================
// 3. DEBT (WHAT YOU OWE)
// =============================================================================
model Debt {
  id                String   @id @default(uuid()) @db.Uuid
  
  // --- Owner ---
  estateId          String   @db.Uuid
  estate            Estate   @relation(fields: [estateId], references: [id], onDelete: Cascade)
  
  // --- Creditor ---
  creditorName      String   @db.VarChar(200)
  creditorContact   String?  @db.VarChar(100)
  
  // --- Details ---
  description       String   @db.Text
  category          DebtCategory
  priority          DebtPriority
  status            DebtStatus @default(OUTSTANDING)
  
  // --- Amounts ---
  originalAmount    Decimal  @db.Decimal(15, 2)
  outstandingBalance Decimal @db.Decimal(15, 2)
  currency          String   @default("KES")
  
  // --- Dates ---
  dueDate           DateTime?
  
  // --- Security ---
  isSecured         Boolean  @default(false)
  securityDetails   String?  @db.Text // "Secured against plot in Kiambu"
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([estateId, priority])
  @@map("debts")
}
// =============================================================================
// 4. WILL (THE INSTRUCTIONS)
// =============================================================================
model Will {
  id              String   @id @default(uuid()) @db.Uuid
  
  // --- Testator (The Person Making the Will) ---
  userId          String   @db.Uuid
  testatorName    String   @db.VarChar(200)
  
  // --- Status ---
  status          WillStatus @default(DRAFT)
  versionNumber   Int        @default(1)
  
  // --- Executor (Who Will Execute the Will) ---
  executorName    String?   @db.VarChar(200)
  executorPhone   String?   @db.VarChar(20)
  executorEmail   String?   @db.VarChar(100)
  executorRelationship String? // "Son", "Daughter", "Lawyer", etc
  
  // --- Special Instructions ---
  funeralWishes   String?   @db.Text
  burialLocation  String?   @db.VarChar(200)
  specialInstructions String? @db.Text
  
  // --- Completeness Tracking ---
  hasExecutor     Boolean   @default(false)
  hasBeneficiaries Boolean  @default(false)
  hasWitnesses    Boolean   @default(false)
  isComplete      Boolean   @default(false)
  completenessScore Int     @default(0) // 0-100
  
  // --- Validation Warnings ---
  validationWarnings String[] // ["Need 2 witnesses", "No beneficiaries added"]
  
  // --- Relations ---
  bequests        Bequest[]
  witnesses       Witness[]
  users User[] @relation("TestatorWills")
  documents Document[]
  // --- Dates ---
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  executedAt      DateTime? // When person dies
  
  @@index([userId, status])
  @@map("wills")
}
// =============================================================================
// 5. BEQUEST (WHO GETS WHAT)
// =============================================================================
model Bequest {
  id              String   @id @default(uuid()) @db.Uuid
  
  // --- Will Link ---
  willId          String   @db.Uuid
  will            Will     @relation(fields: [willId], references: [id], onDelete: Cascade)
  
  // --- Asset Link (Optional) ---
  assetId         String?  @db.Uuid
  asset           Asset?   @relation(fields: [assetId], references: [id])
  
  // --- Beneficiary ---
  beneficiaryName String   @db.VarChar(200)
  beneficiaryType BeneficiaryType
  relationship    String?  @db.VarChar(100)
  
  // --- What They Get ---
  bequestType     BequestType
  percentage      Decimal? @db.Decimal(5, 2) // For percentage-based
  cashAmount      Decimal? @db.Decimal(15, 2) // For cash bequests
  description     String   @db.Text // Human-readable description
  
  // --- Conditions ---
  hasConditions   Boolean  @default(false)
  conditions      String?  @db.Text // "Only if they graduate university"
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([willId])
  @@map("bequests")
}
// =============================================================================
// 6. WITNESS (LEGAL REQUIREMENT)
// =============================================================================
model Witness {
  id              String   @id @default(uuid()) @db.Uuid
  
  // --- Will Link ---
  willId          String   @db.Uuid
  will            Will     @relation(fields: [willId], references: [id], onDelete: Cascade)
  
  // --- Witness Details ---
  fullName        String   @db.VarChar(200)
  nationalId      String?  @db.VarChar(20)
  phoneNumber     String?  @db.VarChar(20)
  email           String?  @db.VarChar(100)
  address         String?  @db.Text
  
  // --- Status ---
  status          WitnessStatus @default(PENDING)
  signedAt        DateTime?
  
  // --- Eligibility Checks ---
  isOver18        Boolean  @default(true)
  isNotBeneficiary Boolean @default(true)
  isMentallyCapable Boolean @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([willId])
  @@map("witnesses")
}
// ============================================================================
// SUCCESSION-AUTOMATION SERVICE
// Purpose: "The Digital Lawyer". Generates forms, tracks readiness, guides the user.
// Updates: Includes SuccessionContext and RiskSource for traceability.
// ============================================================================
// =============================================================================
// 1. READINESS ASSESSMENT (Educational Self-Check)
// =============================================================================

model ReadinessAssessment {
  id                  String   @id @default(uuid()) @db.Uuid
  
  // --- Target User ---
  userId              String   @db.Uuid
  estateId            String   @db.Uuid  // Links to estate-service
  familyId            String?  @db.Uuid  // Links to family-service
  
  // --- Legal Context (Auto-detected) ---
  regime              SuccessionRegime
  religion            SuccessionReligion
  marriageType        MarriageType
  targetCourt         CourtJurisdiction
  
  // --- Context Flags ---
  hasWill             Boolean  @default(false)
  hasMinors           Boolean  @default(false)
  isPolygamous        Boolean  @default(false)
  isInsolvent         Boolean  @default(false)
  requiresGuardian    Boolean  @default(false)
  
  // --- Readiness Score (0-100) ---
  overallScore        Int      @default(0)
  status              ReadinessStatus @default(NOT_STARTED)
  
  // --- Score Breakdown ---
  documentScore       Int      @default(0)  // Out of 30
  legalScore          Int      @default(0)  // Out of 30
  familyScore         Int      @default(0)  // Out of 20
  financialScore      Int      @default(0)  // Out of 20
  
  // --- Analysis Results ---
  totalRisks          Int      @default(0)
  criticalRisks       Int      @default(0)
  highRisks           Int      @default(0)
  mediumRisks         Int      @default(0)
  
  // --- Recommendations ---
  nextSteps           String[]  // ["Get KRA PIN", "Appoint guardian"]
  estimatedDaysToReady Int?
  
  // --- Relations ---
  riskFlags           RiskFlag[]
  estates             Estate[]
  // --- Metadata ---
  lastCheckedAt       DateTime @default(now())
  checkCount          Int      @default(1)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@unique([userId, estateId])
  @@index([userId])
  @@index([estateId])
  @@index([status])
  @@map("readiness_assessments")
}

// =============================================================================
// 2. RISK FLAG (What's Missing or Wrong)
// =============================================================================

model RiskFlag {
  id                  String   @id @default(uuid()) @db.Uuid
  
  // --- Parent ---
  assessmentId        String   @db.Uuid
  assessment          ReadinessAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  
  // --- Risk Details ---
  severity            RiskSeverity
  category            RiskCategory
  title               String   @db.VarChar(200)
  description         String   @db.Text
  
  // --- Legal Reference ---
  legalBasis          String?  @db.Text  // "S.11 LSA - Will must have 2 witnesses"
  
  // --- Resolution ---
  isResolved          Boolean  @default(false)
  resolutionSteps     String[] // ["Upload witness signatures", "Add second witness"]
  
  // --- Impact ---
  isBlocking          Boolean  @default(false)  // Prevents form generation
  affectsScore        Int      @default(0)      // How many points lost
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([assessmentId, severity])
  @@index([isBlocking])
  @@map("risk_flags")
}

// =============================================================================
// 3. EXECUTOR ROADMAP (Step-by-Step Guide)
// =============================================================================

model ExecutorRoadmap {
  id                  String   @id @default(uuid()) @db.Uuid
  
  // --- Target ---
  userId              String   @db.Uuid
  estateId            String   @unique @db.Uuid
  assessmentId        String?  @db.Uuid  // Links to readiness assessment
  
  // --- Context (From Assessment) ---
  regime              SuccessionRegime
  religion            SuccessionReligion
  targetCourt         CourtJurisdiction
  
  // --- Current State ---
  currentPhase        RoadmapPhase @default(PRE_FILING)
  overallProgress     Int      @default(0)  // 0-100%
  
  // --- Task Counts ---
  totalTasks          Int      @default(0)
  completedTasks      Int      @default(0)
  availableTasks      Int      @default(0)
  lockedTasks         Int      @default(0)
  
  // --- Timeline Estimate ---
  estimatedDays       Int?
  startedAt           DateTime @default(now())
  estimatedCompletion DateTime?
  
  // --- Relations ---
  tasks               RoadmapTask[]
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([userId])
  @@index([estateId])
  @@index([currentPhase])
  @@map("executor_roadmaps")
}

// =============================================================================
// 4. ROADMAP TASK (Individual Step)
// =============================================================================

model RoadmapTask {
  id                  String   @id @default(uuid()) @db.Uuid
  
  // --- Parent ---
  roadmapId           String   @db.Uuid
  roadmap             ExecutorRoadmap @relation(fields: [roadmapId], references: [id], onDelete: Cascade)
  
  // --- Task Details ---
  phase               RoadmapPhase
  category            TaskCategory
  orderIndex          Int      // Display order within phase
  
  title               String   @db.VarChar(200)
  description         String   @db.Text
  
  // --- Status ---
  status              TaskStatus @default(LOCKED)
  
  // --- Dependencies ---
  dependsOnTaskIds    String[] // Can't start until these are done
  unlocksTaskIds      String[] // Completing this unlocks these
  
  // --- Educational Content ---
  whatIsIt            String?  @db.Text  // "A Chief's letter is..."
  whyNeeded           String?  @db.Text  // "Required for intestate cases"
  howToGet            String?  @db.Text  // "Visit your local Chief's office"
  estimatedDays       Int?                // How long this step takes
  
  // --- Legal Reference ---
  legalBasis          String?  @db.Text  // "S.26 LSA"
  
  // --- Completion ---
  completedAt         DateTime?
  completedBy         String?  @db.Uuid
  notes               String?  @db.Text  // User's notes
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([roadmapId, phase])
  @@index([status])
  @@map("roadmap_tasks")
}

// =============================================================================
// 5. PROBATE PREVIEW (Form Previews)
// =============================================================================

model ProbatePreview {
  id                  String   @id @default(uuid()) @db.Uuid
  
  // --- Target ---
  userId              String   @db.Uuid
  estateId            String   @db.Uuid
  assessmentId        String?  @db.Uuid
  
  // --- Context ---
  regime              SuccessionRegime
  targetCourt         CourtJurisdiction
  
  // --- Required Forms (Auto-determined) ---
  requiredForms       KenyanFormType[]
  
  // --- Preview Status ---
  isReady             Boolean  @default(false)  // Can generate preview?
  readinessScore      Int      @default(0)
  
  // --- Warning ---
  disclaimer          String   @default("This is an educational preview only. Not for official court submission.")
  
  // --- Relations ---
  formPreviews        FormPreview[]
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@unique([userId, estateId])
  @@index([userId])
  @@index([estateId])
  @@map("probate_previews")
}

// =============================================================================
// 6. FORM PREVIEW (Individual Form HTML)
// =============================================================================

model FormPreview {
  id                  String   @id @default(uuid()) @db.Uuid
  
  // --- Parent ---
  probatePreviewId    String   @db.Uuid
  probatePreview      ProbatePreview @relation(fields: [probatePreviewId], references: [id], onDelete: Cascade)
  
  // --- Form Details ---
  formType            KenyanFormType
  formTitle           String   @db.VarChar(200)
  formCode            String   @db.VarChar(20)  // "P&A 80"
  
  // --- Content ---
  htmlPreview         String   @db.Text  // Pre-filled HTML
  
  // --- Data Source ---
  dataSnapshot        Json     // Snapshot of data used to fill form
  
  // --- Educational Info ---
  purpose             String   @db.Text  // "This form is used to..."
  legalBasis          String?  @db.Text  // "Section 45 LSA"
  instructions        String[] // Step-by-step how to use
  
  // --- Warnings ---
  missingFields       String[] // ["Deceased KRA PIN", "Asset valuation"]
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@unique([probatePreviewId, formType])
  @@map("form_previews")
}

// =============================================================================
// 7. LEGAL GUIDE (Educational Content)
// =============================================================================

model LegalGuide {
  id                  String   @id @default(uuid()) @db.Uuid
  
  // --- Guide Details ---
  category            String   @db.VarChar(100)  // "Forms", "Process", "Requirements"
  title               String   @db.VarChar(200)
  slug                String   @unique
  
  // --- Content ---
  summary             String   @db.Text
  fullContent         String   @db.Text
  
  // --- Context ---
  appliesToRegime     SuccessionRegime[]
  appliesToReligion   SuccessionReligion[]
  
  // --- Legal Reference ---
  legalSections       String[] // ["S.11 LSA", "S.26 LSA"]
  
  // --- Related ---
  relatedFormTypes    KenyanFormType[]
  relatedTasks        String[] // Task categories
  
  // --- SEO ---
  keywords            String[]
  
  // --- Analytics ---
  viewCount           Int      @default(0)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([category])
  @@index([slug])
  @@map("legal_guides")
}
