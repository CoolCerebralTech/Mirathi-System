datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}
// -----------------------------------------------------------------------------
// ENUMS
// -----------------------------------------------------------------------------
enum UserRole {
  USER
  ADMIN
  VERIFIER
  AUDITOR
}
enum GrantStatus {
  ISSUED
  CONFIRMED
  REVOKED
  EXPIRED
  AMENDED
  REPLACED
}
enum ExecutorDutyType {
  FILE_INVENTORY
  PAY_DEBTS
  DISTRIBUTE_ASSETS
  FILE_ACCOUNTS
  OBTAIN_GRANT
  NOTIFY_BENEFICIARIES
  MANAGE_PROPERTY
  SETTLE_TAXES
  CLOSE_ESTATE
  OTHER
}
enum DutyStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
  WAIVED
  EXTENDED
}
enum PriorityLevel {
  HIGH
  MEDIUM
  LOW
}
enum LegalBasis {
  SECTION_83
  SECTION_79
  COURT_ORDER
  WILL_PROVISION
  CUSTOMARY_LAW
}
enum RelationshipType {
  SPOUSE
  EX_SPOUSE          // For divorced/separated spouses
  CHILD
  ADOPTED_CHILD      // Legal distinction for inheritance
  STEPCHILD          // From current/previous marriage
  PARENT
  SIBLING
  HALF_SIBLING       // Same parent
  GRANDCHILD
  GRANDPARENT
  NIECE_NEPHEW
  AUNT_UNCLE
  COUSIN
  GUARDIAN           // Legal guardian (non-parent)
  OTHER
}
enum MarriageType {
  CUSTOMARY
  CHRISTIAN  
  CIVIL
  ISLAMIC
  TRADITIONAL
}
enum GuardianAppointmentSource {
  FAMILY
  COURT
  WILL
  CUSTOMARY_LAW
}
enum WillStatus {
  DRAFT              // Initial creation, editable
  PENDING_WITNESS    // Awaiting witness signatures
  WITNESSED          // Legally witnessed, not yet active
  ACTIVE             // Current valid will
  REVOKED            // Invalidated by user
  SUPERSEDED         // Replaced by newer will
  EXECUTED           // Testator deceased, distribution complete
  CONTESTED          // Under legal dispute
  PROBATE            // In court for grant of probate
}
enum WillType {
  STANDARD
  JOINT_WILL
  MUTUAL_WILL
  HOLOGRAPHIC
  INTERNATIONAL
  TESTAMENTARY_TRUST_WILL
}
enum RevocationMethod {
  NEW_WILL
  CODICIL
  DESTRUCTION
  COURT_ORDER
  MARRIAGE
  DIVORCE
  OTHER
}
enum WillStorageLocation {
  SAFE_DEPOSIT_BOX
  LAWYER_OFFICE
  HOME_SAFE
  DIGITAL_VAULT
  COURT_REGISTRY
  OTHER
}
enum LegalCapacityStatus {
  ASSESSED_COMPETENT
  ASSESSED_INCOMPETENT
  PENDING_ASSESSMENT
  MEDICAL_CERTIFICATION
  COURT_DETERMINATION
  SELF_DECLARATION
}
enum WitnessType {
  REGISTERED_USER
  EXTERNAL_INDIVIDUAL
  PROFESSIONAL_WITNESS
  COURT_OFFICER
  NOTARY_PUBLIC
}
enum WitnessVerificationMethod {
  NATIONAL_ID
  PASSPORT
  DRIVERS_LICENSE
  BIRTH_CERTIFICATE
  ALIEN_CARD
  MILITARY_ID
  OTHER
}
enum WitnessEligibilityStatus {
  ELIGIBLE
  INELIGIBLE_MINOR
  INELIGIBLE_BENEFICIARY
  INELIGIBLE_SPOUSE
  INELIGIBLE_EXECUTOR
  INELIGIBLE_RELATIONSHIP
  INELIGIBLE_MENTAL_CAPACITY
  INELIGIBLE_CRIMINAL_RECORD
  PENDING_ELIGIBILITY_CHECK
}
enum SignatureType {
  DIGITAL_SIGNATURE
  WET_SIGNATURE
  E_SIGNATURE
  BIOMETRIC_SIGNATURE
  WITNESS_MARK
}
enum AssetType {
  LAND_PARCEL        // Title deeds, subdivision plots
  PROPERTY           // Houses, rentals, buildings
  FINANCIAL_ASSET    // Bank accounts, SACCO shares, investments
  DIGITAL_ASSET      // Crypto, NFTs, online portfolios, social media
  BUSINESS_INTEREST  // Company shares, partnerships, farm ventures
  VEHICLE            // Cars, motorcycles, tractors
  INTELLECTUAL_PROPERTY // Patents, copyrights, trademarks
  LIVESTOCK          // Cattle, goats, poultry
  PERSONAL_EFFECTS   // Jewelry, art, family heirlooms
  OTHER
}
enum AssetOwnershipType {
  SOLE               // Single owner
  JOINT_TENANCY      // Joint owners with right of survivorship
  TENANCY_IN_COMMON  // Shared ownership with separate shares
  COMMUNITY_PROPERTY // Marital property
}
enum BequestType {
  SPECIFIC           // Specific asset to specific person
  RESIDUARY          // Remainder after specific bequests
  CONDITIONAL        // Only if condition met
  TRUST              // Held in trust until condition
  PERCENTAGE         // Percentage of total estate
}
enum BequestConditionType {
  AGE_REQUIREMENT    // "When beneficiary turns 25"
  SURVIVAL           // "If they survive me by 30 days"
  EDUCATION          // "Upon graduation"
  MARRIAGE           // "Upon marriage"
  ALTERNATE          // "If primary dies, give to alternate"
  NONE
}
enum GuardianType {
  LEGAL_GUARDIAN     // Full legal custody
  FINANCIAL_GUARDIAN // Manages inheritance only
  PROPERTY_GUARDIAN  // Manages property until age
  TESTAMENTARY       // Appointed via will
}
enum ExecutorStatus {
  NOMINATED          // Named in will, not yet acting
  ACTIVE             // Currently serving
  DECLINED           // Refused to serve
  REMOVED            // Removed by court/testator
  COMPLETED          // Finished duties
}
enum WitnessStatus {
  PENDING            // Awaiting signature
  SIGNED             // Signature captured
  VERIFIED           // Identity verified
  REJECTED           // Declined to witness
}
enum DisputeStatus {
  FILED              // Dispute raised
  UNDER_REVIEW       // Being investigated
  MEDIATION          // In mediation
  COURT_PROCEEDING   // In court
  RESOLVED           // Settled
  DISMISSED          // Thrown out
}
enum DisputeType {
  VALIDITY_CHALLENGE // Will validity questioned
  UNDUE_INFLUENCE    // Coercion alleged
  LACK_CAPACITY      // Testator mental capacity
  FRAUD              // Forgery or misrepresentation
  OMITTED_HEIR       // Heir left out
  ASSET_VALUATION    // Dispute over asset worth
  EXECUTOR_MISCONDUCT // Executor breach of duty
  OTHER
}

enum DistributionStatus {
  PENDING            // Not yet distributed
  IN_PROGRESS        // Being transferred
  COMPLETED          // Transfer done
  DISPUTED           // Under contestation
  DEFERRED           // Delayed by condition
}
enum DebtType {
  MORTGAGE           // Property loan
  PERSONAL_LOAN      // Bank/SACCO loan
  CREDIT_CARD        // Outstanding CC debt
  BUSINESS_DEBT      // Company liabilities
  TAX_OBLIGATION     // Unpaid taxes
  FUNERAL_EXPENSE    // Burial costs
  MEDICAL_BILL       // Healthcare debt
  OTHER
}
enum GrantType {
  PROBATE                               // Form P&A 1: Valid Will + Executor willing to act
  LETTERS_OF_ADMINISTRATION             // Form P&A 80: Intestacy (No Will)
  LETTERS_OF_ADMINISTRATION_WITH_WILL   // Will exists, but no Executor (Admon. Cum Testamento Annexo)
  LIMITED_GRANT                         // Form P&A 80A: Specific purpose (e.g., filing suit, collection only)
  SPECIAL_GRANT                         // For preservation or temporary administration
}
enum MarriageStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
  SEPARATED
  CUSTOMARY_MARRIAGE // Traditional African marriage
  CIVIL_UNION
  ISLAMIC
  CHRISTIAN
}
enum KenyanCounty {
  BARINGO
  BOMET
  BUNGOMA
  BUSIA
  ELGEYO_MARAKWET
  EMBU
  GARISSA
  HOMA_BAY
  ISIOLO
  KAJIADO
  KAKAMEGA
  KERICHO
  KIAMBU
  KILIFI
  KIRINYAGA
  KISII
  KISUMU
  KITUI
  KWALE
  LAIKIPIA
  LAMU
  MACHAKOS
  MAKUENI
  MANDERA
  MARSABIT
  MERU
  MIGORI
  MOMBASA
  MURANGA
  NAIROBI
  NAKURU
  NANDI
  NAROK
  NYAMIRA
  NYANDARUA
  NYERI
  SAMBURU
  SIAYA
  TAITA_TAVETA
  TANA_RIVER
  THARAKA_NITHI
  TRANS_NZOIA
  TURKANA
  UASIN_GISHU
  VIHIGA
  WAJIR
  WEST_POKOT
}
enum AssetVerificationStatus {
  UNVERIFIED
  PENDING_VERIFICATION
  VERIFIED
  REJECTED
  DISPUTED
}
enum AssetEncumbranceType {
  MORTGAGE
  CHARGE
  LIEN
  COURT_ORDER
  FAMILY_CLAIM
  OTHER
}
enum DocumentStatus {
  PENDING_VERIFICATION
  VERIFIED
  REJECTED
}
enum BeneficiaryType {
  USER
  FAMILY_MEMBER  
  EXTERNAL
  CHARITY
  ORGANIZATION
}
enum BequestPriority {
  PRIMARY
  ALTERNATE
  CONTINGENT
}
enum KenyanRelationshipCategory {
  SPOUSE
  CHILDREN
  PARENTS
  SIBLINGS
  EXTENDED_FAMILY
  NON_FAMILY
}
enum DebtPriority {
  HIGHEST    // Funeral expenses, taxes
  HIGH       // Secured debts (mortgages)
  MEDIUM     // Unsecured priority debts
  LOW        // Unsecured non-priority debts
}
enum DebtStatus {
  OUTSTANDING
  PARTIALLY_PAID
  SETTLED
  WRITTEN_OFF
  DISPUTED
  STATUTE_BARRED
}
enum KenyanTaxType {
  INCOME_TAX
  CAPITAL_GAINS_TAX
  STAMP_DUTY
  WITHHOLDING_TAX
  VALUE_ADDED_TAX
  OTHER
}
enum ExecutorEligibilityStatus {
  ELIGIBLE
  INELIGIBLE_MINOR
  INELIGIBLE_BANKRUPT
  INELIGIBLE_CRIMINAL_RECORD
  INELIGIBLE_NON_RESIDENT
  PENDING_VERIFICATION
}
enum ExecutorAppointmentType {
  TESTAMENTARY      // Appointed by will
  COURT_APPOINTED   // Appointed by court
  ADMINISTRATOR     // Letters of administration
  SPECIAL_EXECUTOR  // For specific purposes
}
enum ExecutorCompensationType {
  FIXED_AMOUNT
  PERCENTAGE_OF_ESTATE
  HOURLY_RATE
  STATUTORY_SCALE    // Kenyan Law of Succession Act scale
  NONE
}
enum DependencyLevel {
  NONE
  PARTIAL
  FULL
}
enum InheritanceRights {
  FULL
  PARTIAL
  CUSTOMARY
  NONE
}
enum RelationshipGuardianshipType {
  TEMPORARY
  PERMANENT
  TESTAMENTARY
  CUSTOMARY
}
enum HearingType {
  MENTION
  DIRECTIONS
  HEARING
  RULING
  JUDGMENT
  APPEAL
  REVIEW
  OTHER
}
enum HearingStatus {
  SCHEDULED
  COMPLETED
  ADJOURNED
  CANCELLED
  IN_PROGRESS
}
enum CaseStatus {
  DRAFT_FILING
  FILED
  GAZETTED
  OBJECTION_PERIOD
  OBJECTION_RECEIVED
  HEARING_SCHEDULED
  HEARING_COMPLETED
  GRANT_ISSUED
  CONFIRMATION_HEARING
  CONFIRMED
  APPEALED
  CLOSED
  WITHDRAWN
}
enum CasePriority {
  NORMAL
  URGENT
  EXPEDITED
}
enum GazetteNoticeType {
  PROBATE
  LETTERS_OF_ADMINISTRATION
}
enum ObjectionStatus {
  PENDING
  WITHDRAWN
  DISMISSED
  UPHELD
}
enum ClaimStatus {
  PENDING
  ACCEPTED
  REJECTED
  DISPUTED
  PAID
  PARTIALLY_PAID
}
enum ClaimPriority {
  PREFERRED
  ORDINARY
  SECURED
  UNSECURED
}
enum DocumentCategory {
  LAND_OWNERSHIP       // Title deeds, purchase agreements, land registry extracts
  IDENTITY_PROOF       // National ID, birth certificate, death certificate
  SUCCESSION_DOCUMENT  // Wills, grant of probate, letters of administration
  FINANCIAL_PROOF      // Bank statements, lease documents
  OTHER                // Affidavits, court orders, witness statements
}
enum RetentionPolicy {
  SHORT_TERM  // 1 year
  MEDIUM_TERM // 7 years  
  LONG_TERM   // Permanent
  COMPLIANCE  // Based on regulation
}
enum NotificationChannel {
  EMAIL
  SMS
}
enum NotificationStatus {
  PENDING
  SENT
  FAILED
}
// ============================================================================
// ACCOUNTS SERVICE MODELS
// Owner: accounts-service
// ============================================================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Argon2id hashed password
  firstName String
  lastName  String
  role      UserRole @default(USER)
  isActive     Boolean  @default(true)
  lastLoginAt  DateTime?
  loginAttempts Int     @default(0)
  lockedUntil  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  // --- Relationships Owned by this Service ---
  profile                UserProfile?
  passwordResetTokens    PasswordResetToken[]
  refreshTokens          RefreshToken[]
  roleChanges            RoleChange[]
  emailVerificationToken EmailVerificationToken?
  phoneVerificationTokens PhoneVerificationToken[]
  emailChangeTokens      EmailChangeToken[]
  loginSessions          LoginSession[]
  passwordHistory        PasswordHistory[]

  // --- Back-relations from other services ---
  createdFamilies     Family[]
  familyMemberships   FamilyMember[]
  willsAsTestator     Will[]
  assetsOwned         Asset[]
  beneficiaryOf       BeneficiaryAssignment[]
  willExecutorRoles  WillExecutor[]
  witnessRoles       WillWitness[]
  assetCoOwnerships  AssetCoOwner[]
  debtsOwned         Debt[]
  disputesFiled      Dispute[]
  documentsUploaded   Document[]
  Document Document[] @relation("UserIdentityDocuments")
  DocumentVerificationAttempt DocumentVerificationAttempt[]
  notifications       Notification[]
  auditLogsAsActor    AuditLog[]
  filedCreditorClaims    CreditorClaim[] @relation("ClaimFiledBy")
  reviewedCreditorClaims CreditorClaim[] @relation("ClaimReviewedBy")
  estates Estate[]

  @@index([email, isActive])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("users")
  executorDuties ExecutorDuty[]
}


model UserProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bio           String?
  phoneNumber   String?
  phoneVerified Boolean  @default(false)
  emailVerified Boolean  @default(false)
  marketingOptIn Boolean @default(false)
  address       Json?    // {street, city, county, postalCode}
  nextOfKin     Json?    // {name, relationship, phone, email}

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([phoneNumber])
  @@map("user_profiles")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  tokenHash String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([userId, used])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model RefreshToken {
  id        String   @id @default(uuid())
  tokenHash String   @unique
  expiresAt DateTime
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceId  String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  revokedAt DateTime?
  lastUsedAt DateTime?

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model RoleChange {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  oldRole   UserRole
  newRole   UserRole
  changedBy String?
  reason    String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("role_changes")
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  tokenHash String   @unique
  expiresAt DateTime
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([expiresAt])
  @@map("email_verification_tokens")
}
model PhoneVerificationToken {
  id        String   @id @default(uuid())
  tokenHash String   @unique  // Hashed OTP (6-digit code)
  expiresAt DateTime
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  used      Boolean  @default(false)
  attempts  Int      @default(0) // Track verification attempts
  createdAt DateTime @default(now())

  @@index([userId, used])
  @@index([expiresAt])
  @@map("phone_verification_tokens")
}

model EmailChangeToken {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  newEmail     String   // The new email user wants to change to
  tokenHash    String   @unique
  expiresAt    DateTime
  used         Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@index([userId, used])
  @@index([expiresAt])
  @@map("email_change_tokens")
}

model LoginSession {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash     String    @unique 
  ipAddress     String?  // IPv6 support
  userAgent     String?
  deviceId      String?   // Unique device identifier
  lastActivity  DateTime  @default(now())
  expiresAt     DateTime
  revokedAt     DateTime? // For manual session termination
  createdAt     DateTime  @default(now())

  @@index([userId, expiresAt])
  @@index([deviceId])
  @@map("login_sessions")
}

model PasswordHistory {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  passwordHash String   // Store Argon2id hash of old password
  createdAt    DateTime @default(now())

  @@index([userId, createdAt])
  @@map("password_history")
}
// ============================================================================
// SUCCESSION SERVICE MODELS
// Owner: succession-service
// ============================================================================
// -----------------------------------------------------------------------------
// FAMILY & RELATIONSHIPS (HeirLinkâ„¢)
// -----------------------------------------------------------------------------

model Family {
  id          String   @id @default(uuid())
  name        String   // "The Kamau Family"
  description String?
  creatorId   String
  creator     User     @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  // Family tree visualization data
  treeData    Json?    // For frontend graph rendering
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime? // Soft delete

  // Kenyan Identity Fields (matching entity)
  clanName      String?
  subClan       String?
  ancestralHome String?
  familyTotem   String?
  familyHeadId  String?  // Reference to FamilyMember

  // Statistics (denormalized for performance)
  memberCount        Int    @default(0)
  livingMemberCount  Int    @default(0) 
  minorCount         Int    @default(0)
  customaryMarriageCount Int @default(0)
  polygamousMarriageCount Int @default(0)
  
  // Legal Status
  hasCustomaryMarriage Boolean @default(false)
  hasPolygamousMarriage Boolean @default(false)

  // Relations
  members     FamilyMember[]
  marriages   Marriage[]
  relationships FamilyRelationship[]

  @@index([creatorId])
  @@index([deletedAt])
  @@map("families")
}

model FamilyMember {
  id          String   @id @default(uuid())
  
  // Core Identity
  userId      String?  // Null if non-registered person
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  familyId    String
  family      Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  // External/Non-registered members
  firstName   String?  // For non-users
  lastName    String?
  email       String?
  phone       String?
  dateOfBirth DateTime?
  dateOfDeath DateTime? // Track deceased members
  
  // Relationship context
  relationshipTo String? // "Father of John Kamau"
  role        RelationshipType
  
  // Legal status
  isMinor     Boolean  @default(false)
  isDeceased  Boolean  @default(false)
  
  // Metadata
  notes       String?
  addedBy     String   // User who added this member
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  // Relations
  guardiansAssigned Guardian[] @relation("Ward")
  guardianOf        Guardian[] @relation("Guardian")
  beneficiaryOf     BeneficiaryAssignment[]
  disinheritedFrom  DisinheritanceRecord[]
  
  // Spousal Relations
  marriagesAsSpouse1 Marriage[] @relation("MarriageSpouse1")
  marriagesAsSpouse2 Marriage[] @relation("MarriageSpouse2")

  // Graph Relations (The "Edges" for the Tree)
  relationshipsFrom FamilyRelationship[] @relation("RelationshipFrom")
  relationshipsTo   FamilyRelationship[] @relation("RelationshipTo")

  @@unique([userId, familyId])
  @@index([familyId])
  @@index([userId])
  @@index([isMinor, isDeceased])
  @@index([deletedAt])
  @@index([dateOfBirth, isDeceased]) // For age-based queries
  @@index([firstName, lastName])     // For name searches
  @@index([dateOfDeath])             // For deceased member queries
  @@map("family_members")
  assets Asset[]
}
model FamilyRelationship {
  id            String           @id @default(uuid())
  familyId      String
  family        Family           @relation(fields: [familyId], references: [id], onDelete: Cascade)
  fromMemberId  String
  fromMember    FamilyMember     @relation("RelationshipFrom", fields: [fromMemberId], references: [id], onDelete: Cascade)
  toMemberId    String
  toMember      FamilyMember     @relation("RelationshipTo", fields: [toMemberId], references: [id], onDelete: Cascade)
  type          RelationshipType

  // Kenyan Metadata
  isAdopted Boolean @default(false)
  adoptionOrderNumber String?
  isBiological Boolean @default(true)
  bornOutOfWedlock Boolean @default(false)
  clanRelationship String?
  traditionalRole String?
  isCustomaryAdoption Boolean @default(false)
  adoptionDate DateTime?
  guardianshipType RelationshipGuardianshipType?
  courtOrderNumber String?
  dependencyLevel DependencyLevel @default(NONE)
  inheritanceRights InheritanceRights @default(FULL)
  traditionalInheritanceWeight Float? @default(1.0)
  
  // Verification
  isVerified    Boolean          @default(false)
  verificationMethod String?
  verifiedAt    DateTime?
  verifiedBy    String?
  verificationNotes String?
  verificationDocuments Json? // Array of document IDs
  
  // Metadata for Logic (Adoption, Biology)
  metadata      Json?            // Stores: { isAdopted: boolean, adoptionOrder: string, etc. }

  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@unique([fromMemberId, toMemberId, type]) // Prevent duplicate links
  @@index([familyId])
  @@map("family_relationships")
}
model Marriage {
  id              String   @id @default(uuid())
  familyId        String
  family          Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  // Parties
  spouse1Id       String
  spouse1         FamilyMember @relation("MarriageSpouse1", fields: [spouse1Id], references: [id], onDelete: Cascade)
  spouse2Id       String
  spouse2         FamilyMember @relation("MarriageSpouse2", fields: [spouse2Id], references: [id], onDelete: Cascade)
  
  // Kenyan Marriage Certificate Details
  registrationNumber String?
  issuingAuthority String?
  certificateIssueDate DateTime?
  registrationDistrict String?

  // Dissolution Details
  divorceType String? // 'DIVORCE', 'ANNULMENT', 'DEATH', 'CUSTOMARY_DISSOLUTION'
  
  // Customary Marriage Details
  bridePricePaid Boolean @default(false)
  bridePriceAmount Float?
  bridePriceCurrency String? @default("KES")
  elderWitnesses Json? // Array of strings
  ceremonyLocation String?
  traditionalCeremonyType String?
  lobolaReceiptNumber String?
  marriageElderContact String?
  clanApproval Boolean @default(false)
  familyConsent Boolean @default(false)
  traditionalRitesPerformed Json? // Array of strings
  
  // Marriage Officer Details
  marriageOfficerName String?
  marriageOfficerTitle String?
  marriageOfficerRegistrationNumber String?
  marriageOfficerReligiousDenomination String?
  marriageOfficerLicenseNumber String?
  
  // Marriage Location Details
  marriageVenue String?
  marriageCounty String?
  marriageSubCounty String?
  marriageDistrict String?
  marriageGpsCoordinates String?

  // Marriage details
  marriageDate    DateTime
  marriageType    MarriageStatus
  certificateNumber String?
  
  // Dissolution
  divorceDate     DateTime?
  divorceCertNumber String?
  
  // Status
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([familyId])
  @@index([spouse1Id, spouse2Id])
  @@index([isActive])
  @@map("marriages")
}

model Guardian {
  id          String   @id @default(uuid())
  
  // Guardian details
  guardianId  String   // FamilyMember acting as guardian
  guardian    FamilyMember @relation("Guardian", fields: [guardianId], references: [id], onDelete: Cascade)
  
  // Ward (the minor/dependent)
  wardId      String
  ward        FamilyMember @relation("Ward", fields: [wardId], references: [id], onDelete: Cascade)
  
  // Guardian type
  type        GuardianType
  
  // Legal appointment
  appointedBy String?  // Will ID or court order reference
  appointmentDate DateTime @default(now())
  validUntil  DateTime? // e.g., "until ward turns 18"

  // Kenyan Court Order Fields
  courtOrderNumber String?
  courtName String?
  caseNumber String?
  issuingJudge String?
  courtStation String?
  
  // Guardianship Conditions (JSON fields for arrays)
  conditions Json? // Array of strings
  reportingRequirements Json? // Array of strings  
  restrictedPowers Json? // Array of strings
  specialInstructions Json? // Array of strings
  
  // Status & Review
  isTemporary Boolean @default(false)
  reviewDate DateTime?
  
  // Status
  isActive    Boolean  @default(true)
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([guardianId, wardId, type])
  @@index([guardianId])
  @@index([wardId])
  @@index([isActive])
  @@map("guardians")
}

// -----------------------------------------------------------------------------
// ASSETS & OWNERSHIP
// -----------------------------------------------------------------------------
model Asset {
  id                      String                 @id @default(uuid())
  
  // Core Identity
  name                    String
  description             String?
  type                    AssetType
  
  // Ownership - Kenyan Law Compliance
  ownerId                 String
  owner                   User                   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownershipType           AssetOwnershipType     @default(SOLE)
  ownershipShare          Float // 0-100%
  
  // Kenyan-Specific Location Data
  county                  KenyanCounty?
  subCounty               String?
  ward                    String?
  village                 String?
  landReferenceNumber     String?               // L.R. No for land parcels
  gpsCoordinates          Json?                 // { latitude: Decimal, longitude: Decimal }
  
  // Identification for Kenyan Assets
  titleDeedNumber         String?               // For land/property
  registrationNumber      String?               // General registration
  kraPin                  String?               // KRA PIN if applicable
  identificationDetails   Json?                 // Flexible storage for other IDs
  
  // Valuation - Current and Historical
  currentValue            Float?
  currency                String                @default("KES")
  valuationDate           DateTime?
  valuationSource         String?               // "Professional Valuer", "Market Rate", "Self"
  
  // Legal Status - Kenyan Succession Focus
  verificationStatus      AssetVerificationStatus @default(UNVERIFIED)
  isEncumbered            Boolean               @default(false)
  encumbranceType         AssetEncumbranceType?
  encumbranceDetails      String?
  encumbranceAmount       Float?
  
  // Matrimonial Property Status (Kenyan Law of Succession Act)
  isMatrimonialProperty   Boolean               @default(false)
  acquiredDuringMarriage  Boolean               @default(false)
  spouseConsentRequired   Boolean               @default(false)
  
  // Life Interest Support (Kenyan Succession)
  hasLifeInterest         Boolean               @default(false)
  lifeInterestHolderId    String?               // FamilyMember ID
  lifeInterestEndsAt      DateTime?
  
  // Management & Status
  isActive                Boolean               @default(true)
  requiresProbate         Boolean               @default(true)
  
  // Audit Trail
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  deletedAt               DateTime?
  
  // RELATIONS
  documents               Document[]
  valuationHistory        AssetValuation[]
  coOwners                AssetCoOwner[]
  beneficiaryAssignments  BeneficiaryAssignment[]
  debts                   Debt[]
  lifeInterestHolder      FamilyMember?         @relation(fields: [lifeInterestHolderId], references: [id])
   creditorClaims CreditorClaim[]

  @@index([ownerId, isActive])
  @@index([type, verificationStatus])
  @@index([county, subCounty])
  @@index([titleDeedNumber])
  @@index([isMatrimonialProperty])
  @@index([hasLifeInterest])
  @@index([requiresProbate])
  @@index([deletedAt])
   @@index([currentValue])            // For valuation queries
  @@index([createdAt, ownerId])      // For user asset lists
  @@index([verificationStatus, createdAt]) // For admin review queues
  @@map("assets")
}

model AssetCoOwner {
  id          String   @id @default(uuid())
  assetId     String
  asset       Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  // Co-owner (can be User or external)
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // External co-owner
  fullName    String?
  email       String?
  phone       String?
  
  // Ownership details
  sharePercent Float // 0-100%
  relationship String? // "Spouse", "Business Partner"
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([assetId, userId])
  @@index([assetId])
  @@index([userId])
  @@map("asset_co_owners")
}

model AssetValuation {
  id              String    @id @default(uuid())
  assetId         String
  asset           Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  value           Float
  currency        String    @default("KES")
  valuationDate   DateTime
  valuedBy        String?   // Valuer name or organization
  method          String?   // "Market comparison", "Income approach", "Cost approach"
  purpose         String?   // "Probate", "Insurance", "Sale"
  
  // Kenyan Valuation Standards
  isRegisteredValuer Boolean @default(false)
  valuerRegistrationNumber String?
  
  // Supporting Evidence
  reportUrl       String?   // Link to valuation report
  notes           String?   
  
  createdAt       DateTime  @default(now())

  @@index([assetId, valuationDate])
  @@index([valuationDate, purpose])
  @@map("asset_valuations")
}

model Debt {
  id                      String                 @id @default(uuid())
  
  // Core Debt Information
  ownerId                 String
  owner                   User                   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  type                    DebtType
  description             String
  
  // Asset Linkage
  assetId                 String?
  asset                   Asset?                 @relation(fields: [assetId], references: [id], onDelete: SetNull)
  
  // Financial Details
  principalAmount         Float
  outstandingBalance      Float
  currency                String                 @default("KES")
  
  // Kenyan Tax-Specific Fields
  taxType                 KenyanTaxType?
  kraPin                  String?                // KRA PIN for tax debts
  taxPeriod               String?                // "2023-2024", "Q1 2024"
  
  // Creditor Information
  creditorName            String
  creditorContact         String?
  creditorAddress         Json?                  // { street, city, county, postalCode }
  creditorAccountNumber   String?
  creditorKraPin          String?                // For institutional creditors
  
  // Loan Terms & Conditions
  dueDate                 DateTime?
  interestRate            Float? // Annual %
  interestType            String?                // "Fixed", "Variable", "Compound"
  compoundingFrequency    String?                // "Monthly", "Quarterly", "Annually"
  
  // Kenyan Succession Priority
  priority                DebtPriority           @default(MEDIUM)
  status                  DebtStatus             @default(OUTSTANDING)
  
  // Legal & Compliance
  isStatuteBarred         Boolean                @default(false)
  statuteBarredDate       DateTime?              // When debt becomes unenforceable
  requiresCourtApproval   Boolean                @default(false)
  courtApprovalObtained   Boolean                @default(false)
  
  // Security & Collateral
  isSecured               Boolean                @default(false)
  securityDetails         String?               
  collateralDescription   String?                
  
  // Payment Tracking
  lastPaymentDate         DateTime?
  lastPaymentAmount       Float?
  totalPaid               Float                  @default(0)
  
  // Settlement Information
  isPaid                  Boolean                @default(false)
  paidAt                  DateTime?
  settlementMethod        String?                // "Cash", "Bank Transfer", "Asset Transfer"
  
  // Dispute Information
  isDisputed              Boolean                @default(false)
  disputeReason           String?           
  disputeResolvedAt       DateTime?
  
  // Audit Trail
  incurredDate            DateTime?              // When debt was originally incurred
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt

  // RELATIONS
  paymentHistory          DebtPayment[]
  
  @@index([ownerId, status])
  @@index([assetId])
  @@index([type, priority])
  @@index([dueDate])
  @@index([isSecured])
  @@index([isStatuteBarred])
  @@map("debts")
}
model DebtPayment {
  id              String    @id @default(uuid())
  debtId          String
  debt            Debt      @relation(fields: [debtId], references: [id], onDelete: Cascade)
  
  paymentDate     DateTime
  amount          Float
  currency        String    @default("KES")
  paymentMethod   String?   // "Cash", "Bank Transfer", "Cheque"
  referenceNumber String?   // Payment reference
  paidBy          String?   // Who made the payment
  notes           String?  
  
  createdAt       DateTime  @default(now())

  @@index([debtId, paymentDate])
  @@index([paymentDate])
  @@map("debt_payments")
}
// -----------------------------------------------------------------------------
// WILLS & SUCCESSION
// -----------------------------------------------------------------------------
model Will {
  id                          String                 @id @default(uuid())
  
  // Core Identity
  title                       String
  testatorId                  String
  testator                    User                   @relation(fields: [testatorId], references: [id], onDelete: Cascade)
  
  // Will Classification
  type                        WillType               @default(STANDARD)
  status                      WillStatus             @default(DRAFT)
  
  // Legal Capacity (Section 7 Law of Succession Act)
  legalCapacityStatus         LegalCapacityStatus    @default(PENDING_ASSESSMENT)
  legalCapacityAssessment     Json?                  // Detailed assessment data
  legalCapacityAssessedBy     String?                // User ID of assessor
  legalCapacityAssessedAt     DateTime?
  medicalCertificationId      String?                // Reference to medical document
  
  // Will Dates & Versioning
  willDate                    DateTime               @default(now())
  lastModified                DateTime               @updatedAt
  versionNumber               Int                    @default(1)
  supersedes                  String?                // ID of previous will
  
  // Activation & Execution
  activatedAt                 DateTime?
  activatedBy                 String?                // User who activated
  executedAt                  DateTime?
  executedBy                  String?                // Executor who marked executed
  
  // Revocation (Section 16)
  isRevoked                   Boolean                @default(false)
  revokedAt                   DateTime?
  revokedBy                   String?
  revocationMethod            RevocationMethod?
  revocationReason            String?             
  
  // Kenyan-Specific Content
  funeralWishes               Json?                  // Structured funeral instructions
  burialLocation              String?
  cremationInstructions       String?                
  organDonation               Boolean                @default(false)
  organDonationDetails        String?            
  
  // Estate Distribution
  residuaryClause             String?               
  digitalAssetInstructions    Json?                  // Structured digital asset handling
  specialInstructions         String?               
  
  // Witness Management (Kenyan Legal Requirements)
  requiresWitnesses           Boolean                @default(true)
  witnessCount                Int                    @default(0)
  hasAllWitnesses             Boolean                @default(false)
  minimumWitnessesRequired    Int                    @default(2)
  
  // Legal Formalities (Kenyan Law Compliance)
  isHolographic               Boolean                @default(false)
  isWrittenInTestatorsHand    Boolean                @default(false)
  hasTestatorSignature        Boolean                @default(false)
  signatureWitnessed          Boolean                @default(false)
  meetsKenyanFormalities      Boolean                @default(false)
  
  // Storage & Security
  storageLocation             WillStorageLocation?
  storageDetails              String?                
  isEncrypted                 Boolean                @default(false)
  encryptionKeyId             String?
  
  // Court & Probate Information
  probateCaseNumber           String?
  courtRegistry               String?
  grantOfProbateIssued        Boolean                @default(false)
  grantOfProbateDate          DateTime?
  
  // Dependant Provision (Kenyan Law Section 26)
  hasDependantProvision       Boolean                @default(false)
  dependantProvisionDetails   String?              
  courtApprovedProvision      Boolean                @default(false)
  
  // Record Management
  isActiveRecord              Boolean                @default(true)
  createdAt                   DateTime               @default(now())
  updatedAt                   DateTime               @updatedAt
  deletedAt                   DateTime?
  
  // RELATIONS
  executors                   WillExecutor[]
  witnesses                   WillWitness[]
  beneficiaryAssignments      BeneficiaryAssignment[]
  disinheritances             DisinheritanceRecord[]
  versions                    WillVersion[]
  documents                   Document[]
  disputes                    Dispute[]
  estates                     Estate[]               @relation("EstateWills")
  
  @@index([testatorId, status, createdAt]) // User will dashboard
  @@index([status, isRevoked, deletedAt])  // Admin will management
  @@index([type])
  @@index([legalCapacityStatus])
  @@index([isRevoked])
  @@index([deletedAt])
  @@map("wills")
}
model WillVersion {
  id              String   @id @default(uuid())
  willId          String
  will            Will     @relation(fields: [willId], references: [id], onDelete: Cascade)
  
  versionNumber   Int
  snapshot        Json     // Full will data at time of save
  changeLog       String 
  
  // change tracking
  changeType      String?  // "CREATED", "UPDATED", "WITNESSED", "ACTIVATED"
  changedBy       String
  ipAddress       String?
  userAgent       String?
  
  // Legal significance
  isLegallySignificant Boolean @default(false)
  legalEvent          String?  // "WITNESSING", "REVOCATION", "CODICIL"
  
  createdAt       DateTime @default(now())

  @@unique([willId, versionNumber])
  @@index([willId])
  @@index([createdAt])
  @@index([isLegallySignificant])
  @@map("will_versions")
}
model WillExecutor {
  id                      String                   @id @default(uuid())
  willId                  String
  will                    Will                     @relation(fields: [willId], references: [id], onDelete: Cascade)
  
  // Identity
  executorId              String?                  // Registered user
  executor                User?                    @relation(fields: [executorId], references: [id], onDelete: SetNull)
  
  // External executor details
  fullName                String?
  email                   String?
  phone                   String?
  idNumber                String?                  // National ID for verification
  kraPin                  String?                  // KRA PIN for compensation
  
  // Professional executor details
  isProfessional          Boolean                  @default(false)
  professionalQualification String?               // "Advocate", "CPA", etc.
  practicingCertificateNumber String?
  
  // Relationship context
  relationship            String?                  // "Brother", "Lawyer", "Family Friend"
  relationshipDuration    String?                  // "10 years", "Since 2015"
  
  // Address Information
  physicalAddress         Json?                    // { street, city, county, postalCode }
  postalAddress          Json?                    // { pobox, postalCode, town }
  
  // Role Configuration
  isPrimary               Boolean                  @default(false)
  orderOfPriority         Int                      @default(1)
  appointmentType         ExecutorAppointmentType  @default(TESTAMENTARY)
  
  // Legal Eligibility (Kenyan Law of Succession Act)
  eligibilityStatus       ExecutorEligibilityStatus @default(PENDING_VERIFICATION)
  eligibilityVerifiedAt   DateTime?
  eligibilityVerifiedBy   String?                  // User who verified eligibility
  ineligibilityReason     String?                 
  
  // Appointment & Service Timeline
  status                  ExecutorStatus           @default(NOMINATED)
  nominatedAt             DateTime?                // When named in will
  appointedAt             DateTime?                // Court appointment date
  acceptedAt              DateTime?
  declinedAt              DateTime?
  declineReason           String?                 
  removedAt               DateTime?
  removalReason           String?                 
  completedAt             DateTime?
  
  // Compensation (Kenyan Law of Succession Act Section 83)
  isCompensated           Boolean                  @default(false)
  compensationType        ExecutorCompensationType
  compensationAmount      Float? // Fixed amount
  compensationPercentage  Float?  // % of estate
  hourlyRate              Float? // Hourly rate
  estimatedHours          Int?                     // Estimated time commitment
  courtApprovedCompensation Boolean               @default(false)
  
  // Bond & Security (Kenyan Probate Practice)
  requiresBond            Boolean                  @default(false)
  bondAmount              Float?
  bondProvided            Boolean                  @default(false)
  bondProvider            String?                  // Insurance company
  bondExpiryDate          DateTime?
  
  // Duties & Responsibilities
  specificDuties          String?                  
  limitations             String?                  
  specialPowers           String?                  
  
  // Communication Preferences
  preferredContactMethod  String?                  // "Email", "Phone", "SMS"
  languagePreference      String                   @default("English")
  
  // Audit Trail
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  
  @@index([willId])
  @@index([executorId])
  @@index([isPrimary, status])
  @@index([eligibilityStatus])
  @@index([appointmentType])
  @@map("will_executors")
}
model ExecutorDuty {
  id                      String           @id @default(uuid())
  estateId                String
  estate                  Estate           @relation(fields: [estateId], references: [id], onDelete: Cascade)
  executorId              String
  executor                User             @relation(fields: [executorId], references: [id], onDelete: Cascade)
  
  // Core Duty Information
  type                    ExecutorDutyType
  description             String           
  stepOrder               Int
  deadline                DateTime
  status                  DutyStatus       @default(PENDING)
  priority                PriorityLevel    @default(MEDIUM)
  legalBasis              LegalBasis       @default(SECTION_83)
  
  // Timing & Progress
  startedAt               DateTime?
  estimatedCompletion     DateTime?
  completedAt             DateTime?
  
  // Documentation & References
  notes                   String?         
  supportingDocuments     Json?        // Array of document IDs
  courtOrderNumber        String?          // Reference to court order if applicable
  
  // Extension Tracking
  previousDeadline        DateTime?        // For tracking extensions
  extensionReason         String?         
  extendedBy              String?          // User who approved extension
  extensionDate           DateTime?
  
  // Overdue Tracking
  overdueNotificationsSent Int            @default(0)
  lastOverdueNotification  DateTime?
  
  // Audit Trail
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  
  // Indexes for Performance
  @@index([estateId, status])
  @@index([executorId, deadline])
  @@index([status, priority])
  @@index([deadline])
  @@index([type])
  @@map("executor_duties")
}
model WillWitness {
  id                      String                   @id @default(uuid())
  willId                  String
  will                    Will                     @relation(fields: [willId], references: [id], onDelete: Cascade)
  
  // Identity
  witnessType             WitnessType
  witnessId               String?                  // Registered user
  witness                 User?                    @relation(fields: [witnessId], references: [id], onDelete: SetNull)
  
  // External witness details
  fullName                String
  email                   String?
  phone                   String?
  
  // Kenyan Identification
  idNumber                String?                  // National ID
  idType                  WitnessVerificationMethod?
  idDocumentId            String?                  // Reference to uploaded ID document
  idVerified              Boolean                  @default(false)
  
  // Professional witness details
  isProfessionalWitness   Boolean                  @default(false)
  professionalCapacity    String?                  // "Advocate", "Notary", "Commissioner for Oaths"
  professionalLicense     String?
  
  // Relationship Context
  relationship            String?                  // "Neighbor", "Colleague", "Friend"
  relationshipDuration    String?                  // "5 years", "Since 2018"
  knowsTestatorWell       Boolean                  @default(true)
  
  // Address Information
  physicalAddress         Json?                    // { street, city, county, postalCode }
  residentialCounty       String?                  // Kenyan county of residence
  
  // Legal Eligibility (Kenyan Law of Succession Act)
  eligibilityStatus       WitnessEligibilityStatus @default(PENDING_ELIGIBILITY_CHECK)
  eligibilityVerifiedAt   DateTime?
  eligibilityVerifiedBy   String?
  ineligibilityReason     String?         
  
  // Witnessing Process
  status                  WitnessStatus            @default(PENDING)
  signedAt                DateTime?
  signatureType           SignatureType?
  signatureData           String?                 
  signatureLocation       String?                  // Physical or digital location
  witnessingMethod        String?                  // "In Person", "Video Conference", "Digital Platform"
  
  // Verification
  verifiedAt              DateTime?
  verifiedBy              String?                  // Admin who verified identity
  verificationMethod      WitnessVerificationMethod?
  verificationNotes       String?                
  
  // Legal Requirements Tracking
  isEligible              Boolean                  @default(true)
  hasConflictOfInterest   Boolean                  @default(false)
  conflictDetails         String?                 
  understandsObligation   Boolean                  @default(false)
  obligationAcknowledgedAt DateTime?
  
  // Communication & Notifications
  invitationSentAt        DateTime?
  invitationMethod        String?                  // "Email", "SMS", "In Person"
  reminderSentAt          DateTime?
  responseReceivedAt      DateTime?
  
  // Audit Trail
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt

  // RELATIONS
  identityDocuments       Document[]               @relation("WitnessIdentityDocuments")
  
  @@index([willId])
  @@index([witnessId])
  @@index([witnessType])
  @@index([eligibilityStatus])
  @@index([status])
  @@index([idNumber])
  @@map("will_witnesses")
}
// -----------------------------------------------------------------------------
// BENEFICIARY ASSIGNMENTS & BEQUESTS
// -----------------------------------------------------------------------------
model BeneficiaryAssignment {
  id                      String                 @id @default(uuid())
  
  // Will & Asset linkage
  willId                  String
  will                    Will                   @relation(fields: [willId], references: [id], onDelete: Cascade)
  assetId                 String
  asset                   Asset                  @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  // Beneficiary Identity
  beneficiaryType         BeneficiaryType
  userId                  String?
  beneficiary             User?                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  familyMemberId          String?
  familyMember            FamilyMember?          @relation(fields: [familyMemberId], references: [id], onDelete: Cascade)
  
  // External beneficiary details
  externalName            String?
  externalContact         String?
  externalIdentification  String?                // ID number for external beneficiaries
  externalAddress         Json?                  // { street, city, county, postalCode }
  
  // Kenyan Relationship Context
  relationshipCategory    KenyanRelationshipCategory
  specificRelationship    String?                // "Son", "Daughter", "Nephew", etc.
  isDependant            Boolean                @default(false) // Kenyan Law of Succession Act dependant
  
  // Bequest Configuration
  bequestType             BequestType            @default(SPECIFIC)
  sharePercent            Float? // 0-100%
  specificAmount          Float? // Fixed amount
  currency                String                 @default("KES")
  
  // Conditions for Kenyan Law
  conditionType           BequestConditionType   @default(NONE)
  conditionDetails        String?                
  conditionMet           Boolean?               // Track condition status
  conditionDeadline       DateTime?              // When condition must be met
  
  // Life Interest Support (Kenyan Succession)
  hasLifeInterest         Boolean                @default(false)
  lifeInterestDuration    Int?                   // Years for life interest
  lifeInterestEndsAt      DateTime?
  
  // Alternate Beneficiary
  alternateAssignmentId   String?
  alternateAssignment     BeneficiaryAssignment? @relation("AlternateBeneficiary", fields: [alternateAssignmentId], references: [id])
  
  // Distribution Tracking
  distributionStatus      DistributionStatus     @default(PENDING)
  distributedAt           DateTime?
  distributionNotes       String?                
  distributionMethod      String?                // "Cash", "Transfer", "Physical"
  
  // Legal Compliance (Kenyan Law)
  isSubjectToDependantsProvision Boolean @default(false)
  courtApprovalRequired   Boolean                @default(false)
  courtApprovalObtained   Boolean                @default(false)
  
  // Priority & Order
  priority                Int                    @default(1)
  bequestPriority         BequestPriority        @default(PRIMARY)
  
  // Audit Trail
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt

  // RELATIONS
  alternateFor            BeneficiaryAssignment[] @relation("AlternateBeneficiary")
  
  @@unique([willId, assetId, userId])
  @@unique([willId, assetId, familyMemberId])
  @@unique([willId, assetId, externalName])
  @@index([willId])
  @@index([assetId])
  @@index([beneficiaryType])
  @@index([isDependant])
  @@index([distributionStatus])
  @@index([priority])
  @@map("beneficiary_assignments")
}

model DisinheritanceRecord {
  id          String   @id @default(uuid())
  willId      String
  will        Will     @relation(fields: [willId], references: [id], onDelete: Cascade)
  
  // Person being disinherited
  disinheritedMemberId String
  disinheritedMember   FamilyMember @relation(fields: [disinheritedMemberId], references: [id], onDelete: Cascade)
  
  // Reason 
  reason      String? 
  
  // Legal notice
  wasNotified Boolean  @default(false)
  notifiedAt  DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([willId, disinheritedMemberId])
  @@index([willId])
  @@index([disinheritedMemberId])
  @@map("disinheritance_records")
}

// -----------------------------------------------------------------------------
// DISPUTES & CONTESTATION
// -----------------------------------------------------------------------------

model Dispute {
  id          String   @id @default(uuid())
  willId      String
  will        Will     @relation(fields: [willId], references: [id], onDelete: Cascade)
  
  // Disputing party
  disputantId String
  disputant   User     @relation(fields: [disputantId], references: [id], onDelete: Cascade)
  
  // Dispute details
  type        DisputeType
  status      DisputeStatus @default(FILED)
  description String  
  
  // Legal representation
  lawyerName  String?
  lawyerContact String?
  caseNumber  String?  // Court case reference
  
  // Timeline
  filedAt     DateTime @default(now())
  resolvedAt  DateTime?
  resolution  String? 
  
  // Supporting evidence
  evidenceUrls Json? // Links to uploaded documents
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([willId, status])
  @@index([disputantId])
  @@map("disputes")
}
// ----------------------
// Estate & Administration
// ----------------------
model Estate {
  id               String    @id @default(uuid())
  deceasedUserId   String?   // If deceased was a registered user (optional)
  deceasedName     String
  dateOfDeath      DateTime?
  probateCaseNumber String?  // Court reference / Probate case no
  estateValue      Float?
  currency         String    @default("KES")
  status           DistributionStatus @default(PENDING) // reuse enum
  administrationType GrantType?
  administratorId  String?   // User who is administrator/executor (may be WillExecutor.userId)
  administrator    User?     @relation(fields: [administratorId], references: [id], onDelete: SetNull)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  closedAt         DateTime?

  deceasedDateOfBirth DateTime?        // Important for age calculations
  deceasedIdNumber    String?          // National ID
  deceasedKraPin      String?          // KRA PIN for tax purposes
  placeOfDeath        String?          // Kenyan legal requirement
  deathCertificateNumber String?       // Official document reference
  burialPermitNumber  String?          // Kenyan burial permit
  
  // Estate administration timeline
  administrationStartedAt DateTime?
  administrationCompletedAt DateTime?
  estimatedCompletionDate DateTime?
  
  // Tax compliance (Kenyan requirements)
  taxComplianceCertificateNumber String?
  taxComplianceCertificateDate DateTime?
  estateDutyPaid Boolean @default(false)
  estateDutyAmount Float?
  
  // Court information
  primaryCourtStation String?          // e.g., "Nairobi High Court"
  courtFileReference  String?          // Physical file tracking

  // relations
  wills           Will[]            @relation("EstateWills")
  inventories     EstateInventory[]
  grants          GrantOfAdministration[]
  accounting      EstateAccounting?
  claims          CreditorClaim[]
  distributions   DistributionSchedule[]
  entitlements    BeneficiaryEntitlement[]
  intestacyCases IntestacyCase[]
  testamentaryTrusts TestamentaryTrust[]
  probateCases ProbateCase[]
  executorDuties ExecutorDuty[]

  @@index([deceasedUserId])
  @@index([probateCaseNumber])
  @@index([status, createdAt])
  @@index([administrationType, status])
  @@index([dateOfDeath])
  @@index([estateValue])
  @@index([createdAt, closedAt])
  @@index([deceasedIdNumber])
  @@map("estates")
}

model EstateInventory {
  id          String   @id @default(uuid())
  estateId    String
  estate      Estate   @relation(fields: [estateId], references: [id], onDelete: Cascade)
  assetId     String?  // linked Asset if recorded
  description String   
  estimatedValue Float?
  currency    String   @default("KES")
  ownedByDeceased Boolean @default(true)
  createdAt   DateTime @default(now())

  @@index([estateId, assetId])
  @@map("estate_inventories")
  probateCases ProbateCase[]
}
model GrantOfAdministration {
  id               String      @id @default(uuid())
  estateId         String
  estate           Estate      @relation(fields: [estateId], references: [id], onDelete: Cascade)
  applicantId      String?     // User applying
  applicantName    String?
  grantType        GrantType 
  issuedBy         String?     // Court user id or clerk
  issuedAt         DateTime?
  expiresAt        DateTime?
  caseNumber       String?     // The "E123 of 2024" number
  fileReference    String?     // Physical file tracking
  notes            String?     
  status           GrantStatus @default(ISSUED) // CHANGED FROM DistributionStatus
  
  // New fields for comprehensive certificate management
  grantNumber      String?     @unique // Official grant number from court
  courtStation     String?     // Kenyan court station
  confirmedBy      String?     // User who confirmed the grant
  confirmationDate DateTime?   // When grant was confirmed
  revokedBy        String?     // User who revoked the grant
  revocationDate   DateTime?   // When grant was revoked
  revocationReason String?     // Reason for revocation
  courtOrderNumber String?     // Court order reference for amendments/revocations
  isActive         Boolean     @default(true)
  conditions       Json?    // Array of conditions attached to grant
  
  // Amendment tracking
  amendmentHistory Json?       // Array of amendment records
  
  // Replacement tracking
  replacedByGrantId String?    // Reference to new grant if replaced
  replacementReason String?    
  
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  // RELATIONS
  probateCase      ProbateCase? @relation("CaseGrants", fields: [probateCaseId], references: [id])
  probateCaseId    String?

  @@index([estateId, applicantId])
  @@index([grantNumber])
  @@index([courtStation])
  @@index([status, isActive])
  @@index([issuedAt])
  @@index([expiresAt])
  @@map("grants_of_administration")
}
model ProbateCase {
  id                      String              @id @default(uuid())
  estateId                String
  estate                  Estate              @relation(fields: [estateId], references: [id], onDelete: Cascade)
  
  // Kenyan Court Identification
  caseNumber              String?             @unique
  courtLevel              String              // "HIGH_COURT", "PRINCIPAL_MAGISTRATE", "DISTRICT_MAGISTRATE"
  courtStation            String              // e.g., "NAIROBI", "MOMBASA", "NAKURU"
  courtCounty             KenyanCounty
  
  // Application Details (Kenyan Law of Succession Act)
  applicationType         GrantType
  status                  CaseStatus          @default(DRAFT_FILING)
  priority                CasePriority        @default(NORMAL)
  
  // Gazette Notice (Kenya Gazette Requirements)
  gazetteNoticeNumber     String?
  gazettePublicationDate  DateTime?
  gazetteObjectionPeriodDays Int?            // Typically 30 days for Kenyan probate
  gazetteNoticeType       GazetteNoticeType?
  
  // Filing Information
  filingDate              DateTime?
  filingFee               Float?
  filedBy                 String?             // User ID who filed
  
  // Applicant Information (Kenyan Legal Requirements)
  applicantId             String?             // User ID of applicant
  applicantName           String?
  applicantRelationship   String?             // Relationship to deceased
  applicantContactInfo    String?
  
  // Legal Representation
  lawyerName              String?
  lawyerFirm             String?
  lawyerContactInfo      String?
  
  // Grant Tracking
  grantId                 String?             // Reference to GrantOfAdministration
  // Inventory Reference
  inventoryId            String?             // Reference to EstateInventory
  inventory              EstateInventory?    @relation(fields: [inventoryId], references: [id])
  
  // Case Closure
  closureDate            DateTime?
  closureReason          String?            
  closedBy               String?             // User ID who closed
  
  // Kenyan Court Performance Tracking
  isExpedited            Boolean             @default(false)
  requiresConfirmationHearing Boolean        @default(false)
  confirmationHearingDate DateTime?
  
  // Audit Trail
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  
  // RELATIONS
  objections             Objection[]
  hearings               CourtHearing[]
  grants                 GrantOfAdministration[] @relation("CaseGrants")
  
  // Indexes for Kenyan Court Performance
  @@index([estateId, status])
  @@index([caseNumber])
  @@index([courtStation, filingDate])
  @@index([status, createdAt])
  @@index([applicantId])
  @@index([filingDate])
  @@map("probate_cases")
}
model Objection {
  id              String           @id @default(uuid())
  probateCaseId   String
  probateCase     ProbateCase      @relation(fields: [probateCaseId], references: [id], onDelete: Cascade)
  
  // Objector Information
  objectorName    String
  objectorContact String?          // Phone/email for notifications
  objectorRelationship String?     // Relationship to deceased
  
  // Kenyan Legal Grounds
  grounds         Json?        // Array of legal grounds per Kenyan law
  supportingEvidence String?      // Description of evidence
  
  // Objection Management
  filingDate      DateTime         @default(now())
  status          ObjectionStatus  @default(PENDING)
  hearingDate     DateTime?        // Scheduled hearing date
  outcomeNotes    String?         
  
  // Legal Representation
  objectorLawyerName String?
  objectorLawyerFirm String?
  
  // Withdrawal/Dismissal
  withdrawnAt     DateTime?
  withdrawalReason String?        
  dismissedAt     DateTime?
  dismissalReason String?         
  upheldAt        DateTime?
  
  // Audit Trail
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  @@index([probateCaseId, status])
  @@index([filingDate])
  @@index([objectorName])
  @@map("objections")
}
// ----------------------
// Creditor Claims & Accounting
// ----------------------
model CreditorClaim {
  id                      String          @id @default(uuid())
  estateId                String
  estate                  Estate          @relation(fields: [estateId], references: [id], onDelete: Cascade)
  
  // Creditor Information (Kenyan Legal Requirements)
  creditorName            String
  creditorContact         String?         // Phone/email for notifications
  creditorKraPin          String?         // KRA PIN for institutional creditors
  creditorAccountNumber   String?         // For payment processing
  
  // Claim Details (Kenyan Law of Succession Act)
  claimType               DebtType
  description             String        
  priority                ClaimPriority
  
  // Financial Details
  amountClaimed           Float
  currency                String          @default("KES")
  interestRate            Float?         // Annual percentage
  interestType            String?         // "SIMPLE", "COMPOUND"
  compoundingFrequency    String?         // "MONTHLY", "QUARTERLY", "ANNUALLY"
  
  // Due Date & Time Limitations (Kenyan Law)
  dueDate                 DateTime?
  isStatuteBarred         Boolean         @default(false)
  statuteBarredDate       DateTime?       // When claim becomes unenforceable
  
  // Security & Collateral (Kenyan Legal Framework)
  isSecured               Boolean         @default(false)
  securityDetails         String?        
  collateralDescription   String?        
  securedAssetId          String?         // Reference to specific asset
  securedAsset            Asset?          @relation(fields: [securedAssetId], references: [id])
  
  // Supporting Evidence
  supportingDocumentId    String?         // Main supporting document
  supportingDocuments     Json?       // Array of additional document IDs
  
  // Court & Legal References
  courtCaseNumber         String?         // If already in court
  courtStation            String?         // Kenyan court handling the case
  
  // Claim Workflow (Kenyan Succession Process)
  status                  ClaimStatus     @default(PENDING)
  
  // FIXED: Added relation names to disambiguate User references
  filedByUserId           String?         // User who filed the claim
  filedBy                 User?           @relation("ClaimFiledBy", fields: [filedByUserId], references: [id])
  
  // Review & Approval
  reviewedByUserId        String?         // Administrator/executor who reviewed
  reviewedBy              User?           @relation("ClaimReviewedBy", fields: [reviewedByUserId], references: [id])
  reviewedAt              DateTime?
  rejectionReason         String?        
  
  // Dispute Tracking
  isDisputed              Boolean         @default(false)
  disputeReason           String?        
  disputeResolvedAt       DateTime?
  
  // Payment Tracking (Kenyan Payment Methods)
  paidAmount              Float             @default(0)
  paymentDate             DateTime?
  paymentMethod           String?         // "BANK_TRANSFER", "CHEQUE", "MPESA", "CASH", "RTGS"
  transactionReference    String?         // M-PESA ref, cheque number, etc.
  paymentNotes            String?     
  
  // Legal Compliance (Kenyan Requirements)
  requiresCourtApproval   Boolean         @default(false)
  courtApprovalObtained   Boolean         @default(false)
  courtApprovalDate       DateTime?
  
  // Audit Trail
  resolvedAt              DateTime?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  
  // RELATIONS
  paymentHistory          ClaimPayment[]
  
  // Indexes for Kenyan Legal Performance
  @@index([estateId, status])
  @@index([creditorName])
  @@index([claimType, priority])
  @@index([dueDate])
  @@index([isStatuteBarred])
  @@index([isSecured])
  @@index([filedByUserId])
  @@map("creditor_claims")
}
model ClaimPayment {
  id                      String          @id @default(uuid())
  creditorClaimId         String
  creditorClaim           CreditorClaim   @relation(fields: [creditorClaimId], references: [id], onDelete: Cascade)
  
  paymentDate             DateTime
  amount                  Float
  currency                String          @default("KES")
  paymentMethod           String          // "BANK_TRANSFER", "CHEQUE", "MPESA", "CASH", "RTGS"
  transactionReference    String?         // M-PESA ref, cheque number, etc.
  paidBy                  String?         // User who made the payment
  notes                   String?        
  
  // Kenyan Banking Details
  bankName                String?
  accountNumber           String?
  chequeNumber            String?
  mpesaReference          String?
  
  createdAt               DateTime        @default(now())
  
  @@index([creditorClaimId, paymentDate])
  @@index([paymentDate])
  @@map("claim_payments")
}
model EstateAccounting {
  id               String   @id @default(uuid())
  estateId         String   @unique
  estate           Estate   @relation(fields: [estateId], references: [id], onDelete: Cascade)
  totalAssets      Float
  totalLiabilities Float
  netEstateValue   Float
  preparedById     String?
  preparedAt       DateTime?
  auditedAt        DateTime?
  notes            String? 
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("estate_accountings")
}
// ----------------------
// Distribution & Entitlements (intestacy/testate handling)
// ----------------------
model BeneficiaryEntitlement {
  id                String   @id @default(uuid())
  estateId          String
  estate            Estate   @relation(fields: [estateId], references: [id], onDelete: Cascade)
  beneficiaryUserId String?
  beneficiaryFamilyMemberId String?
  externalName      String?
  relationship      RelationshipType?
  entitlementType   BequestType @default(SPECIFIC)
  sharePercent      Float?
  fixedAmount       Float?
  lifeInterest      Boolean  @default(false)
  lifeInterestEndsAt DateTime?
  isMinor           Boolean  @default(false)
  heldInTrustId     String?  // links to TestamentaryTrust
  distributionStatus DistributionStatus @default(PENDING)
  distributedAt     DateTime?
  priority          Int     @default(1)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([estateId, beneficiaryUserId])
  @@map("beneficiary_entitlements")
}
model DistributionSchedule {
  id          String   @id @default(uuid())
  estateId    String
  estate      Estate   @relation(fields: [estateId], references: [id], onDelete: Cascade)
  stepOrder   Int
  stepType    String   // "SETTLE_DEBTS","LIQUIDATE_ASSET","PAY_CLAIMS","DISTRIBUTE_CASH","TRANSFER_ASSET"
  description String?
  dueDate     DateTime?
  completed   Boolean  @default(false)
  completedAt DateTime?
  createdAt   DateTime @default(now())

  @@index([estateId, stepOrder])
  @@map("distribution_schedules")
}
// ----------------------
// Intestacy helper (store computed decision path)
// ----------------------
model IntestacyCase {
  id             String   @id @default(uuid())
  estateId       String
  computedAt     DateTime @default(now())
  decisionJson   Json     // store the computed heir order, shares, life interests etc
  computedBy     String?  // service/process id
  notes          String?
  estate         Estate   @relation(fields: [estateId], references: [id], onDelete: Cascade)

  @@index([estateId])
  @@map("intestacy_cases")
}

// ----------------------
// Testamentary Trusts (for minors / conditional bequests)
// ----------------------
model TestamentaryTrust {
  id           String   @id @default(uuid())
  estateId     String
  trusteeId    String?  // User acting as trustee
  trusteeName  String?
  purpose      String? 
  validUntil   DateTime? // e.g., until beneficiary reaches 18/25
  fundsHeld    Float?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  estate       Estate   @relation(fields: [estateId], references: [id], onDelete: Cascade)

  @@index([estateId, trusteeId])
  @@map("testamentary_trusts")
}
model CourtHearing {
  id                  String          @id @default(uuid())
  
  // Core Case Reference
  caseId              String
  probateCase         ProbateCase     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  // Kenyan Court Identification
  hearingNumber       String          @unique
  causeListNumber     String?
  courtStation        String          // e.g., "Nairobi High Court", "Milimani Law Courts"
  courtroom           String?
  
  // Scheduling & Timing
  date                DateTime
  startTime           String          @default("09:00") // Kenyan court hours
  endTime             String          @default("10:00")
  type                HearingType
  
  // Judicial Officers
  judgeName           String?
  presidedBy          String?         // Could be magistrate or deputy registrar
  
  // Hearing Management
  status              HearingStatus   @default(SCHEDULED)
  virtualLink         String?         // For virtual hearings
  minutesTaken        Boolean         @default(false)
  ordersIssued        Boolean         @default(false)
  
  // Adjournment Tracking (Kenyan courts)
  adjournmentCount    Int             @default(0)
  adjournmentReasons  Json?        // Array of adjournment reasons
  
  // Hearing Outcome
  outcomeNotes        String?         
  outcome             Json?           // Structured outcome: { orders: string[], rulings: string[], nextSteps: string[] }
  
  // Compliance Tracking
  complianceDeadline  DateTime?
  
  // Audit Trail
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  
  // Indexes for Kenyan Court Performance
  @@index([caseId, date])
  @@index([date, status])
  @@index([courtStation, date])
  @@index([hearingNumber])
  @@index([complianceDeadline])
  @@map("court_hearings")
}
// ============================================================================
// DOCUMENTS SERVICE MODELS
// Owner: documents-service
// ============================================================================

model Document {
  id          String           @id @default(uuid())
  version     Int
  filename    String
  storagePath String           // Local path or cloud URL
  mimeType    String          
  sizeBytes   Int
  category    DocumentCategory
  status      DocumentStatus   @default(PENDING_VERIFICATION)

  // --- Ownership & Upload Info ---
  uploaderId  String
  uploader    User             @relation(fields: [uploaderId], references: [id], onDelete: Cascade)
  identityForUserId String?
  identityForUser   User?   @relation("UserIdentityDocuments", fields: [identityForUserId], references: [id], onDelete: Cascade)


  // --- Verification Tracking ---
  verifiedBy     String?       // User ID of verifier (ADMIN or VERIFIER role)
  verifiedAt     DateTime?
  rejectionReason String?     

  // Retention & Expiry
  expiresAt   DateTime? // Auto-delete after this date
  retentionPolicy String? // COMPLIANCE, LEGAL, etc.

  // Access Control List
  allowedViewers Json? // User IDs who can view this document

  // Security & Access
  isPublic    Boolean   @default(false)
  encrypted   Boolean   @default(false)

  // --- Cross-Service Links (Direct Foreign Keys) ---
  // A document can be linked to EITHER an Asset OR a Will (or neither for identity docs)
  assetId     String?
  asset       Asset?           @relation(fields: [assetId], references: [id], onDelete: Cascade)
  willId      String?
  will        Will?            @relation(fields: [willId], references: [id], onDelete: Cascade)

  // --- Metadata (Optional - for future AI/OCR extraction) ---
  metadata    Json?            // Store extracted data like parcel numbers, ID numbers, etc.

  // --- Timestamps ---
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  deletedAt   DateTime?        // Soft delete support

  // Enhanced metadata for common document types
  documentNumber String? // ID number, parcel number, etc.
  issueDate      DateTime?
  expiryDate     DateTime?
  issuingAuthority String?

  // Storage optimization
  storageProvider String @default("local") // "s3", "gcs", "azure"
  checksum       String? // File integrity check
  
  // Performance fields
  isIndexed      Boolean @default(false) // For search indexing
  indexedAt      DateTime?

  // --- Relations ---
  versions    DocumentVersion[]
  verificationAttempts        DocumentVerificationAttempt[]
  willWitnesses WillWitness[] @relation("WitnessIdentityDocuments") 

  // --- Indexes for Performance ---
  @@index([uploaderId, status, createdAt])
  @@index([category, status, createdAt])
  @@index([assetId, willId, identityForUserId])
  @@index([createdAt, deletedAt])
  @@index([uploaderId])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([isPublic])
  @@index([encrypted])
  @@index([documentNumber])
  @@index([expiryDate])
  @@map("documents")
}

model DocumentVersion {
  id            String   @id @default(uuid())
  versionNumber Int
  storagePath   String
  changeNote    String?  
  sizeBytes     Int      // Track size per version
  mimeType      String   
  checksum      String? 
  
  documentId    String
  document      Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  uploadedBy    String   // User who uploaded this version
  createdAt     DateTime @default(now())

  @@unique([documentId, versionNumber])
  @@index([documentId])
  @@index([createdAt])
  @@map("document_versions")
}

model DocumentVerificationAttempt {
  id        String   @id @default(uuid())
  documentId String
  document  Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  verifierId String   // User ID of the verifier
  verifier    User     @relation(fields: [verifierId], references: [id], onDelete: Cascade)
  status     DocumentStatus // VERIFIED or REJECTED
  reason     String?   // Corresponds to rejectionReason
  metadata    Json?    // Additional verification data
  createdAt  DateTime @default(now())

  @@index([documentId])
  @@index([verifierId])
  @@index([createdAt])
  @@map("document_verification_attempts")
}

// ============================================================================
// NOTIFICATIONS SERVICE MODELS (Unchanged for now)
// Owner: notifications-service
// ============================================================================

model NotificationTemplate {
  id      String              @id @default(uuid())
  name    String              @unique
  channel NotificationChannel
  subject String?
  body    String

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  notifications Notification[]
}

model Notification {
  id          String             @id @default(uuid())
  channel     NotificationChannel
  status      NotificationStatus @default(PENDING)
  sentAt      DateTime?
  failReason  String?
  templateId  String
  template    NotificationTemplate @relation(fields: [templateId], references: [id])
  recipientId String?
  recipient   User?              @relation(fields: [recipientId], references: [id], onDelete: SetNull)
  createdAt   DateTime           @default(now())

  @@index([recipientId, status])
}

// ============================================================================
// AUDITING SERVICE MODEL (Unchanged for now)
// Owner: auditing-service
// ============================================================================

model AuditLog {
  id        String   @id @default(uuid())
  timestamp DateTime @default(now())
  actorId   String?
  actor     User?    @relation(fields: [actorId], references: [id], onDelete: SetNull)
  action    String
  payload   Json

  @@index([actorId])
  @@index([action, timestamp])
}
